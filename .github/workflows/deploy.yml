name: Deploy Voice Coding Assistant to Linode (Nginx only)

on:
  push:
    branches: [ master ]
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive
          clean: false

      # Use workspace versions of apps/packages; do not reclone external repos

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20' # Use Node.js 20, as specified in package.json
          cache: 'pnpm' # Cache pnpm dependencies for faster builds
          cache-dependency-path: pnpm-lock.yaml

      - name: Install root dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build
        run: |
          cat > ./frontend/.env << EOL
          VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          EOL
          pnpm run build
          
          # Force-patch compiled adapter dist to explicit ESM specifiers (defense-in-depth)
          if [ -f "packages/sql-storage-adapter/dist/index.js" ]; then
            echo "Patching compiled adapter dist/index.js to explicit .js specifiers..."
            sed -i "s|from '\\./types'|from './types/index.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./core/database'|from './core/database.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./core/resolver'|from './core/resolver.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./adapters/betterSqliteAdapter'|from './adapters/betterSqliteAdapter.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./adapters/sqlJsAdapter'|from './adapters/sqlJsAdapter.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./adapters/indexedDbAdapter'|from './adapters/indexedDbAdapter.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./adapters/capacitorSqliteAdapter'|from './adapters/capacitorSqliteAdapter.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./adapters/postgresAdapter'|from './adapters/postgresAdapter.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./adapters/supabase'|from './adapters/supabase/index.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./adapters/baseStorageAdapter'|from './adapters/baseStorageAdapter.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./features/backup/cloudBackup'|from './features/backup/cloudBackup.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./features/migrations/dataExport'|from './features/migrations/dataExport.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./features/migrations/dataImport'|from './features/migrations/dataImport.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./features/migrations/migration'|from './features/migrations/migration.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./features/sync/syncManager'|from './features/sync/syncManager.js'|g" packages/sql-storage-adapter/dist/index.js || true
            sed -i "s|from '\\./shared/parameterUtils'|from './shared/parameterUtils.js'|g" packages/sql-storage-adapter/dist/index.js || true
            echo "--- Adapter dist/index.js head ---"
            head -n 80 packages/sql-storage-adapter/dist/index.js || true
            echo "----------------------------------"
          fi
          
          # Verify backend build completed successfully
          if [ ! -f "backend/dist/server.js" ]; then
              echo "ERROR: backend/dist/server.js not found after build!"
              exit 1
          fi
          
          # Verify critical backend files exist
          if [ ! -f "backend/dist/middleware/optionalAuth.js" ]; then
              echo "ERROR: backend/dist/middleware/optionalAuth.js not found after build!"
              echo "Backend dist contents:"
              find backend/dist -type f | head -20
              exit 1
          fi
          
          echo "Backend build verification passed"
        env:
          NODE_ENV: production

      - name: Create deployment package
        run: |
          # Clean deployment directory first
          rm -rf deployment
          
          mkdir -p deployment/frontend/dist
          mkdir -p deployment/backend/dist
          mkdir -p deployment/backend/packs
          mkdir -p deployment/prompts
          mkdir -p deployment/backend/prompts

          # Copy built frontend assets
          cp -r frontend/dist/* deployment/frontend/dist/

          # Copy built backend assets (preserve directory structure)
          # Use rsync or ensure all subdirectories are copied
          cp -r backend/dist/. deployment/backend/dist/ 2>&1 || {
              echo "ERROR: Failed to copy backend/dist files"
              echo "Source directory contents:"
              find backend/dist -type f | head -30
              exit 1
          }
          
          # Verify critical files were copied
          echo "Verifying copied files..."
          echo "Backend dist structure after copy:"
          find deployment/backend/dist -type f -name "*.js" | head -30
          
          if [ ! -f "deployment/backend/dist/server.js" ]; then
              echo "ERROR: server.js not copied to deployment package!"
              exit 1
          fi
          if [ ! -f "deployment/backend/dist/middleware/optionalAuth.js" ]; then
              echo "ERROR: optionalAuth.js not copied to deployment package!"
              echo "Files in deployment/backend/dist:"
              find deployment/backend/dist -type f | head -30
              echo "Middleware directory contents:"
              ls -la deployment/backend/dist/middleware/ || echo "middleware directory doesn't exist"
              exit 1
          fi
          if [ ! -f "deployment/backend/dist/middleware/auth.js" ]; then
              echo "ERROR: auth.js not copied to deployment package!"
              exit 1
          fi
          if [ ! -f "deployment/backend/dist/src/features/prompts/prompt.routes.js" ]; then
              echo "ERROR: prompt.routes.js missing from deployment backend dist!"
              find deployment/backend/dist/src/features -maxdepth 2 -type f
              exit 1
          fi
          if [ ! -f "deployment/backend/dist/utils/logger.js" ]; then
              echo "ERROR: logger.js missing from deployment backend dist!"
              find deployment/backend/dist -maxdepth 2 -type f
              exit 1
          fi
          
          echo "All critical backend files verified in deployment package"
          
          # Copy backend package.json for npm install on server
          cp backend/package.json deployment/backend/package.json

          # Patch nested workspace deps inside AgentOS before packing so npm can resolve them
          node .github/scripts/patch-agentos-deps-for-pack.js

          # Package internal workspace deps into tarballs for npm to consume on the server
          pnpm --filter "@framers/agentos" pack --pack-destination deployment/backend/packs
          pnpm --filter "@framers/sql-storage-adapter" pack --pack-destination deployment/backend/packs

          # Restore AgentOS package.json after packing (so repo stays clean)
          node .github/scripts/restore-agentos-deps-after-pack.js
          
          # Debug: List packed files
          echo "Packed files:"
          ls -la deployment/backend/packs/

          # Rewrite workspace:* deps to local file tarballs so npm (no workspaces) can install them
          node .github/scripts/rewrite-workspace-deps.js deployment/backend/package.json deployment/backend/packs
          
          # Debug: Show rewritten package.json dependencies
          echo "Rewritten backend package.json dependencies:"
          node -e "console.log(JSON.parse(require('fs').readFileSync('deployment/backend/package.json', 'utf8')).dependencies)"
          # Copy prompts for dynamic loading
          cp -r prompts/* deployment/prompts/
          cp -r prompts/* deployment/backend/prompts/

          # Copy ecosystem.config.js for PM2
          # Ensure ecosystem.config.js is in the backend directory in the deployment package
          cp backend/ecosystem.config.json deployment/backend/ecosystem.config.json

          # Copy Nginx configuration
          cp frontend/nginx.conf deployment/nginx.conf

          # Create a tarball of the deployment package
          cd deployment && tar -czf ../voice-app-deployment.tar.gz .

      - name: Verify packed adapter uses explicit ESM paths
        shell: bash
        run: |
          set -euo pipefail
          # After pack step above, ensure tarball index.js has .js extensions
          ADAPTER_TGZ=$(ls deployment/backend/packs | grep framers-sql-storage-adapter | head -n1 || true)
          if [ -z "$ADAPTER_TGZ" ]; then
            echo "Adapter tarball not found in packs dir"; exit 1;
          fi
          echo "Inspecting $ADAPTER_TGZ ..."
          tar -xOf "deployment/backend/packs/$ADAPTER_TGZ" package/dist/index.js | tee /tmp/adapter-index.js > /dev/null
          grep -q "./types/index.js" /tmp/adapter-index.js || { echo "Missing types/index.js export in adapter dist"; exit 1; }
          grep -q "./core/database.js" /tmp/adapter-index.js || { echo "Missing .js extension for core/database export"; exit 1; }
          grep -q "./features/sync/syncManager.js" /tmp/adapter-index.js || { echo "Missing .js extension for features exports"; exit 1; }

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: 'just-a-placeholder-so-we-dont-get-errors'

      - name: Add Linode to known hosts
        run: ssh-keyscan -H ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Linode
        run: |
          echo "Copying deployment package to Linode..."
          scp voice-app-deployment.tar.gz ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}:~/

          echo "Connecting to Linode and deploying application..."
          ssh ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} << 'EOF'

          # 1. Prepare deployment directory
          echo "Preparing application directory..."
          mkdir -p ~/voice-coding-assistant-temp
          tar -xzf ~/voice-app-deployment.tar.gz -C ~/voice-coding-assistant-temp
          rm ~/voice-app-deployment.tar.gz

          rm -rf ~/voice-coding-assistant-old
          if [ -d ~/voice-coding-assistant ]; then
              mv ~/voice-coding-assistant ~/voice-coding-assistant-old
          fi
          mv ~/voice-coding-assistant-temp ~/voice-coding-assistant

          # Verify backend dist files were extracted correctly
          echo "Verifying extracted backend dist files..."
          BACKEND_DIST="$HOME/voice-coding-assistant/backend/dist"
          if [ ! -f "$BACKEND_DIST/server.js" ]; then
              echo "ERROR: server.js not found after extraction!"
              ls -la "$BACKEND_DIST" || echo "dist directory doesn't exist"
              exit 1
          fi
          if [ ! -f "$BACKEND_DIST/middleware/optionalAuth.js" ]; then
              echo "ERROR: optionalAuth.js not found after extraction!"
              echo "Backend dist structure:"
              find "$BACKEND_DIST" -type f -name '*.js' | head -30
              echo "Middleware directory:"
              ls -la "$BACKEND_DIST/middleware/" || echo "middleware directory doesn't exist"
              exit 1
          fi
          if [ ! -f "$BACKEND_DIST/middleware/auth.js" ]; then
              echo "ERROR: auth.js not found after extraction!"
              ls -la "$BACKEND_DIST/middleware/" || echo "middleware directory doesn't exist"
              exit 1
          fi
          if [ ! -f "$BACKEND_DIST/src/features/prompts/prompt.routes.js" ]; then
              echo "ERROR: prompt.routes.js not found after extraction!"
              find "$BACKEND_DIST/src/features" -maxdepth 2 -type f
              exit 1
          fi
          if [ ! -f "$BACKEND_DIST/utils/logger.js" ]; then
              echo "ERROR: logger.js not found after extraction!"
              find "$BACKEND_DIST/utils" -maxdepth 1 -type f
              exit 1
          fi
          echo "Backend dist files verified after extraction"

          # move frontend to where it can be accessible by nginx
          sudo cp -r ~/voice-coding-assistant/frontend/dist/* /var/www/voice-coding-assistant/

          # CHANGE 1: Navigate to the *root* of your backend application (where package.json and ecosystem.config.js are)
          cd ~/voice-coding-assistant/backend || { echo "ERROR: Could not navigate to backend directory."; exit 1; }

          # Already installed on the server
          # # 2. Install Node.js, npm, PM2, and Nginx
          # echo "Installing Node.js, npm, PM2, and Nginx..."
          # sudo apt-get update -y
          # sudo apt-get install -y nodejs npm nginx

          # if ! command -v node &> /dev/null; then
          #    echo "Creating symlink for node command..."
          #    sudo ln -s /usr/bin/nodejs /usr/bin/node
          # fi

          # sudo npm install -g pm2

          # 3. Install backend dependencies (Node.js direct deploy)
          echo "Installing backend Node.js dependencies on server..."
          # Clean npm cache and remove old node_modules to ensure fresh install
          rm -rf node_modules package-lock.json
          npm cache clean --force
          npm install --production --legacy-peer-deps # Install only production dependencies with legacy peer deps
          
          # Verify critical dependencies were installed
          if [ ! -d "node_modules/express" ]; then
              echo "ERROR: express not installed in node_modules!"
              echo "node_modules contents:"
              ls -la node_modules/ | head -20
              exit 1
          fi
          
          echo "Dependencies installed successfully"

          # Re-verify critical runtime files in case npm install altered the build
          if [ ! -f "$BACKEND_DIST/middleware/optionalAuth.js" ] || [ ! -f "$BACKEND_DIST/middleware/auth.js" ]; then
              echo "ERROR: Middleware files missing after npm install!"
              ls -la "$BACKEND_DIST/middleware/" || echo "middleware directory missing"
              exit 1
          fi
          if [ ! -f "$BACKEND_DIST/utils/logger.js" ]; then
              echo "ERROR: logger.js missing after npm install!"
              find "$BACKEND_DIST/utils" -maxdepth 1 -type f
              exit 1
          fi
          if [ ! -f "$BACKEND_DIST/src/features/prompts/prompt.routes.js" ]; then
              echo "ERROR: prompt.routes.js missing after npm install!"
              find "$BACKEND_DIST/src/features" -maxdepth 2 -type f
              exit 1
          fi

          echo "Post-install verification passed"

          # 4. Create .env file for the backend
          echo "Creating .env file for backend..."
          echo "${{ secrets.ENV }}" > ~/voice-coding-assistant/.env
          echo ".env file created."

          # 5. Configure Nginx
          echo "Configuring Nginx..."
          # **CRITICAL: Clean up old Nginx site configurations to avoid conflicts**
          sudo rm -f /etc/nginx/sites-enabled/*
          sudo rm -f /etc/nginx/sites-available/default # Remove any old default file if it exists

          # Copy new Nginx configuration
          sudo cp ~/voice-coding-assistant/nginx.conf /etc/nginx/sites-available/voice-coding-assistant.conf
          # Create a symbolic link to enable the site
          sudo ln -s /etc/nginx/sites-available/voice-coding-assistant.conf /etc/nginx/sites-enabled/voice-coding-assistant.conf

          # create ssl
          sudo mkdir -p /etc/nginx/ssl
          sudo sh -c 'printf "%s" "${{ secrets.SSL_CERT }}" > /etc/nginx/ssl/cert.pem'
          sudo sh -c 'printf "%s" "${{ secrets.SSL_KEY }}" > /etc/nginx/ssl/key.pem'

          # Adjust Nginx config paths and proxy_pass in the copied file
          # Replace root path
          sudo sed -i "s|root /usr/share/nginx/html;|root /home/${{ secrets.LINODE_USER }}/voice-coding-assistant/frontend/dist;|g" /etc/nginx/sites-available/voice-coding-assistant.conf
          # Replace proxy_pass to point to localhost:3333
          sudo sed -i "s|proxy_pass http://backend:3333;|proxy_pass http://localhost:3333;|g" /etc/nginx/sites-available/voice-coding-assistant.conf
          # Ensure there are no malformed 'Connection' headers.
          # The provided nginx.conf has: proxy_set_header Connection 'upgrade';
          # This is correct. If the error was from a previous or manually edited file, it should be fixed by the clean up.

          sudo nginx -t && sudo systemctl reload nginx || { echo "ERROR: Nginx configuration test failed or reload failed."; exit 1; }
          sudo systemctl enable nginx || { echo "WARNING: Nginx not enabled to start on boot."; }
          sudo systemctl start nginx || { echo "ERROR: Nginx failed to start."; exit 1; }
          echo "Nginx configured and started."

          # 6. Configure and start backend with PM2
          echo "Configuring and starting backend with PM2..."
          
          # Verify backend build exists
          if [ ! -f "dist/server.js" ]; then
              echo "ERROR: dist/server.js not found! Backend was not built properly."
              ls -la dist/ || echo "dist directory doesn't exist"
              exit 1
          fi
          
          # Verify critical middleware file exists
          if [ ! -f "dist/middleware/optionalAuth.js" ]; then
              echo "ERROR: dist/middleware/optionalAuth.js not found!"
              echo "dist directory structure:"
              find dist -type f | head -30
              exit 1
          fi
          
          echo "Backend dist files verified"
          
          pm2 stop voice-backend || true
          pm2 delete voice-backend || true

          # Start or reload using ecosystem (ensures node_args and env applied)
          pm2 startOrReload ecosystem.config.json --update-env

          # Save PM2 process list and configure to start on boot
          pm2 save
          pm2 startup systemd # This generates and enables a systemd unit for PM2
          echo "PM2 backend configured and started."

          # 7. Basic Health Checks
          echo "Verifying Nginx and PM2 status..."
          sudo systemctl is-active nginx || { echo "ERROR: Nginx is not active."; exit 1; }
          pm2 list | grep 'voice-backend' | grep 'online' || { echo "ERROR: Backend PM2 process is not online."; exit 1; }
          
          # Show PM2 logs for debugging
          echo "=== PM2 Process Status ==="
          pm2 status
          echo "=== Recent PM2 Logs ==="
          pm2 logs voice-backend --lines 50 --nostream || true

          echo "Waiting for application to become fully responsive via HTTP..."
          ATTEMPTS=0
          MAX_ATTEMPTS=15
          BACKOFF_SECONDS=10
          APP_HEALTHY=false

          while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              echo "Attempt $((ATTEMPTS+1)) of $MAX_ATTEMPTS: Checking application health endpoint..."
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3333/health)
              if [ "$HTTP_STATUS" -eq 200 ]; then
                  echo "Application /health endpoint returned 200 OK. Application is responsive."
                  APP_HEALTHY=true
                  break
              else
                  echo "Health check failed with status $HTTP_STATUS. Retrying in $BACKOFF_SECONDS seconds..."
                  sleep $BACKOFF_SECONDS
              fi
              ATTEMPTS=$((ATTEMPTS+1))
          done

          if [ "$APP_HEALTHY" = false ]; then
              echo "ERROR: Application did not become healthy after $MAX_ATTEMPTS attempts."
              echo "Review PM2 logs: pm2 logs voice-backend"
              exit 1
          fi
          echo "Deployment successful and application verified."

          EOF
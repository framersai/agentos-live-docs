name: Deploy Voice Coding Assistant to Linode with Docker

on:
  push:
    branches: [ master ]
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # No need for Node.js setup or npm install/build steps here,
      # as Docker will handle dependencies and builds inside the containers.
      # The 'npm run install-all' and 'npm run build' are part of the Dockerfiles.

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Known hosts is just a placeholder; for production, generate this securely
          # and store it as a secret, then use 'known_hosts: ${{ secrets.KNOWN_HOSTS }}'
          known_hosts: 'just-a-placeholder-so-we-dont-get-errors' 

      - name: Add Linode to known hosts
        run: ssh-keyscan -H ${{ secrets.LINODE_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Linode via Docker Compose
        run: |
          # Copy the entire repository to the Linode server
          # This ensures all necessary files (Dockerfiles, docker-compose.yml, nginx.conf) are present
          echo "Copying repository to Linode..."
          scp -r . ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}:~/voice-coding-assistant-temp

          echo "Connecting to Linode and deploying with Docker Compose..."
          ssh ${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }} << 'EOF'
          # Ensure Docker and Docker Compose are installed
          if ! command -v docker &> /dev/null; then
              echo "Docker not found, installing..."
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              sudo chmod a+r /etc/apt/keyrings/docker.gpg
              echo "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
              sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              sudo usermod -aG docker ${{ secrets.LINODE_USER }}
              echo "Docker installed. Please log out and back in for group changes to take effect if running manually."
              # For CI/CD, the newgrp command below will make the change effective for the current session
              newgrp docker || true # '|| true' prevents script from failing if newgrp isn't available or fails
          fi

          # Clean up previous deployment directory and move new one into place
          rm -rf ~/voice-coding-assistant-old
          if [ -d ~/voice-coding-assistant ]; then
              mv ~/voice-coding-assistant ~/voice-coding-assistant-old
          fi
          mv ~/voice-coding-assistant-temp ~/voice-coding-assistant
          
          cd ~/voice-coding-assistant

          # Create .env file from GitHub Actions secrets
          echo "Creating .env file..."
          cat > .env << EOL
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
          PASSWORD=${{ secrets.PASSWORD }}
          MODEL_PREF_CODING=${{ secrets.MODEL_PREF_CODING }}
          MODEL_PREF_SYSTEM_DESIGN=${{ secrets.MODEL_PREF_SYSTEM_DESIGN }}
          MODEL_PREF_SUMMARY=${{ secrets.MODEL_PREF_SUMMARY }}
          COST_THRESHOLD=${{ secrets.COST_THRESHOLD }}
          DEFAULT_LANGUAGE=${{ secrets.DEFAULT_LANGUAGE }}
          TOKEN_LIMIT=${{ secrets.TOKEN_LIMIT }}
          PORT=${{ secrets.PORT }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          SPEECH_PREFERENCE=${{ secrets.SPEECH_PREFERENCE }}
          NODE_ENV=production # Ensure production mode for Docker containers
          EOL

          # Stop and remove old containers (if any) and then build and start new ones
          echo "Stopping and removing old Docker containers..."
          docker compose down || true # '|| true' prevents script from failing if containers don't exist

          echo "Building and starting new Docker containers..."
          docker compose up -d --build

          echo "Docker Compose deployment complete. Checking service status..."
          docker compose ps

          # Optional: Clean up old Docker images and volumes
          # docker system prune -a -f

          EOF

name: Deploy GitPayWidget to Linode

# This workflow deploys gitpaywidget.com
# Disabled by default - enable workflow_dispatch or push triggers as needed
on:
  workflow_dispatch:  # Manual trigger only
  # push:
  #   branches: [master, dev, main, develop]
  #   paths:
  #     - 'apps/gitpaywidget/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Skip if SSH key is not configured
    if: ${{ secrets.SSH_PRIVATE_KEY != '' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to gitpaywidget.com
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: ${{ secrets.LINODE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/gitpaywidget || git clone https://github.com/manicinc/gitpaywidget.git /opt/gitpaywidget
            cd /opt/gitpaywidget
            git pull origin master || git pull origin main
            # Ensure .env directory exists (persisted, NOT in repo)
            mkdir -p apps/gitpaywidget
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml build --no-cache
            docker-compose -f docker-compose.prod.yml up -d
            docker system prune -af


name: Deploy to Linode (PM2 + Nginx) [fixed]

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: deploy-vca-fixed
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout (metadata only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate SSH key secret
        shell: bash
        run: |
          set -euo pipefail
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/deploy_key
          if [ ! -s /tmp/deploy_key ]; then
            echo "SSH_PRIVATE_KEY secret is missing or empty"; exit 1
          fi
          head -n1 /tmp/deploy_key | grep -q 'BEGIN OPENSSH PRIVATE KEY' || { echo "SSH_PRIVATE_KEY must be an OpenSSH private key PEM"; exit 1; }
          chmod 600 /tmp/deploy_key
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no -i /tmp/deploy_key "${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}" "echo '[ok] ssh connectivity]'" >/dev/null

      - name: Deploy to server over SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: ${{ secrets.LINODE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail
            set -x
            export DEBIAN_FRONTEND=noninteractive
            export GH_PAT="${{ secrets.GH_PAT }}"

            echo "GH_PAT_SET=${GH_PAT:+yes}"
            node -v || true

            echo "[bootstrap] Ensure base packages..."
            apt-get update -y
            apt-get install -y --no-install-recommends ca-certificates curl git

            if ! command -v node >/dev/null 2>&1; then
              echo "[bootstrap] Install Node 20.x..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi

            echo "[bootstrap] Ensure pm2..."
            npm i -g pm2
            pm2 -v || true

            APP_DIR="$HOME/voice-chat-assistant"
            AUTH_URL="https://manicinc:${GH_PAT}@github.com/manicinc/voice-chat-assistant.git"

            # Ensure submodules use HTTPs with PAT instead of SSH to avoid host-key issues
            git config --global url."https://manicinc:${GH_PAT}@github.com/".insteadOf "https://github.com/"
            git config --global url."https://manicinc:${GH_PAT}@github.com/".insteadOf "git@github.com:"
            git config --global url."https://github.com/".insteadOf "git@github.com:"

            echo "[debug] Checking repo access with GH_PAT..."
            git ls-remote --heads "${AUTH_URL}"

            # Clone repo if missing, otherwise ensure correct origin URL
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "[deploy] Clone repository..."
              git clone "${AUTH_URL}" "$APP_DIR"
            fi

            echo "[deploy] Ensure origin URL is correct..."
            git -C "$APP_DIR" remote set-url origin "${AUTH_URL}" || true

            echo "[deploy] Sync to latest master..."
            git -C "$APP_DIR" fetch --all --prune
            git -C "$APP_DIR" checkout master
            git -C "$APP_DIR" reset --hard origin/master

            echo "[deploy] Write .env from secret..."
            printf "%s" "${{ secrets.ENV_PROD }}" > "$APP_DIR/.env"

            echo "[deploy] Init/update submodules..."
            git -C "$APP_DIR" submodule update --init --recursive

            echo "[deploy] Install workspace deps (npm workspaces)..."
            cd "$APP_DIR"
            if command -v npm >/dev/null 2>&1; then
              npm ci || npm install
            else
              echo "npm not found"; exit 1
            fi

            echo "[build] Build workspace..."
            npm run build

            echo "[deploy] Publish frontend static to Nginx root..."
            FRONTEND_DIST="$APP_DIR/frontend/dist"
            WEB_ROOT="/var/www/app.vca.chat"
            if [ -d "$FRONTEND_DIST" ]; then
              mkdir -p "$WEB_ROOT"
              rsync -a --delete "$FRONTEND_DIST/" "$WEB_ROOT/"
            else
              echo "[warn] Frontend dist not found at $FRONTEND_DIST"
            fi

            echo "[nginx] Reload to pick up new assets..."
            nginx -t && systemctl reload nginx || true

            echo "[pm2] Start/restart backend..."
            pm2 delete voice-backend >/dev/null 2>&1 || true
            pm2 start backend/dist/server.js --name voice-backend --node-args="--experimental-specifier-resolution=node"
            pm2 save

            echo "[health] GET /health on 3333..."
            if ! curl -fsS http://127.0.0.1:3333/health ; then
              echo "[health] backend failed to start"; exit 1
            fi

      - name: Tail PM2 logs (last 120 lines)
        if: always()
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: ${{ secrets.LINODE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: false
          command_timeout: 5m
          script: |
            pm2 logs voice-backend --lines 120 --nostream || true



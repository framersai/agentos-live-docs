name: Deploy to Linode (PM2 + Nginx) [fixed]

on:
  push:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: deploy-vca-fixed
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout (metadata only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate SSH key secret
        shell: bash
        run: |
          set -euo pipefail
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/deploy_key
          if [ ! -s /tmp/deploy_key ]; then
            echo "SSH_PRIVATE_KEY secret is missing or empty"; exit 1
          fi
          head -n1 /tmp/deploy_key | grep -q 'BEGIN OPENSSH PRIVATE KEY' || { echo "SSH_PRIVATE_KEY must be an OpenSSH private key PEM"; exit 1; }
          chmod 600 /tmp/deploy_key
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no -i /tmp/deploy_key "${{ secrets.LINODE_USER }}@${{ secrets.LINODE_HOST }}" "echo '[ok] ssh connectivity]'" >/dev/null

      - name: Deploy to server over SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: ${{ secrets.LINODE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail
            set -x
            export DEBIAN_FRONTEND=noninteractive
            export GH_PAT="${{ secrets.GH_PAT }}"

            echo "GH_PAT_SET=${GH_PAT:+yes}"
            node -v || true

            echo "[bootstrap] Ensure base packages..."
            apt-get update -y
            apt-get install -y --no-install-recommends ca-certificates curl git

            if ! command -v node >/dev/null 2>&1; then
              echo "[bootstrap] Install Node 20.x..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi

            echo "[bootstrap] Ensure pm2..."
            # Ensure pnpm via Corepack (pinned from packageManager field); fallback to global install if needed
            corepack enable || true
            corepack prepare pnpm@10.15.1 --activate || true
            pnpm -v || (npm i -g pnpm@10.15.1 && pnpm -v)

            # PM2 can remain installed via npm globally
            npm i -g pm2
            pm2 -v || true
            # Ensure TypeScript CLI is globally available for submodules invoking `npx tsc`
            npm i -g typescript@5.6.3

            APP_DIR="$HOME/voice-chat-assistant"
            AUTH_URL="https://manicinc:${GH_PAT}@github.com/manicinc/voice-chat-assistant.git"

            # Ensure submodules use HTTPs with PAT instead of SSH to avoid host-key issues
            git config --global url."https://manicinc:${GH_PAT}@github.com/".insteadOf "https://github.com/"
            git config --global url."https://manicinc:${GH_PAT}@github.com/".insteadOf "git@github.com:"
            git config --global url."https://github.com/".insteadOf "git@github.com:"

            echo "[debug] Checking repo access with GH_PAT..."
            git ls-remote --heads "${AUTH_URL}"

            # Always start from a clean checkout to avoid dirty submodule/node_modules state
            if [ -d "$APP_DIR" ]; then
              echo "[deploy] Removing existing checkout to ensure clean workspace..."
              rm -rf "$APP_DIR"
            fi

            echo "[deploy] Clone repository..."
            git clone "${AUTH_URL}" "$APP_DIR"

            echo "[deploy] Ensure origin URL is correct..."
            git -C "$APP_DIR" remote set-url origin "${AUTH_URL}" || true

            echo "[deploy] Sync to latest master..."
            git -C "$APP_DIR" fetch --all --prune
            git -C "$APP_DIR" checkout master
            git -C "$APP_DIR" reset --hard origin/master

            echo "[deploy] Write .env from secret..."
            printf "%s" "${{ secrets.ENV_PROD }}" > "$APP_DIR/.env"

            echo "[deploy] Init/update submodules..."
            git -C "$APP_DIR" submodule update --init --recursive

            echo "[install] Install workspace dependencies with pnpm..."
            if command -v pnpm >/dev/null 2>&1; then
              pnpm -C "$APP_DIR" install --no-frozen-lockfile
            else
              echo "pnpm not found"; exit 1
            fi

            echo "[packages] Build internal workspace libraries (shared + storage + agentos)..."
            pnpm -C "$APP_DIR" --filter "@framers/shared" run build

            ADAPTER_DIR="$APP_DIR/packages/sql-storage-adapter"
            echo "[packages] Build sql-storage-adapter without npx dependency..."
            pnpm --dir "$ADAPTER_DIR" run clean
            pnpm --dir "$ADAPTER_DIR" exec tsc -p tsconfig.build.json
            pnpm --dir "$ADAPTER_DIR" exec node scripts/fix-esm-imports.mjs

            pnpm -C "$APP_DIR" --filter "@framers/agentos" run build

            echo "[backend] Build..."
            if [ -d "$APP_DIR/backend" ]; then
              pnpm -C "$APP_DIR" --filter "voice-chat-assistant-backend" run build
            else
              echo "[warn] backend directory not found at $APP_DIR/backend"
            fi

            echo "[frontend] Build..."
            if [ -d "$APP_DIR/frontend" ]; then
              pnpm -C "$APP_DIR" --filter "voice-chat-assistant-frontend" run build
              # Frontend node_modules not needed after static build
              rm -rf "$APP_DIR/frontend/node_modules" || true
            else
              echo "[warn] frontend directory not found at $APP_DIR/frontend"
            fi

            echo "[deploy] Publish frontend static to Nginx root..."
            FRONTEND_DIST="$APP_DIR/frontend/dist"
            WEB_ROOT="/var/www/app.vca.chat"
            if [ -d "$FRONTEND_DIST" ]; then
              mkdir -p "$WEB_ROOT"
              rsync -a --delete "$FRONTEND_DIST/" "$WEB_ROOT/"
            else
              echo "[warn] Frontend dist not found at $FRONTEND_DIST"
            fi

            echo "[nginx] Reload to pick up new assets..."
            nginx -t && systemctl reload nginx || true

            echo "[pm2] Start/restart backend..."
            # Ensure backend listens on 3333 so the health-check matches
            export PORT="${PORT:-3333}"
            pm2 delete voice-backend >/dev/null 2>&1 || true
            pm2 start "$APP_DIR/backend/dist/server.js" --name voice-backend --node-args="--experimental-specifier-resolution=node"
            pm2 save

            echo "[health] GET /health on ${PORT:-3333} (with retries)..."
            health_ok=0
            health_attempts=${BACKEND_HEALTH_ATTEMPTS:-20}
            health_sleep=${BACKEND_HEALTH_SLEEP:-5}
            for attempt in $(seq 1 $health_attempts); do
              if curl -fsS "http://127.0.0.1:${PORT:-3333}/health" >/dev/null 2>&1 ; then
                health_ok=1
                echo "[health] backend is up after attempt ${attempt}."
                break
              fi
              echo "[health] attempt ${attempt}/${health_attempts} failed; retrying in ${health_sleep}s..."
              sleep "$health_sleep"
            done
            if [ "$health_ok" -ne 1 ]; then
              echo "[health] backend failed to start after retries"; exit 1
            fi

            echo "[cleanup] Prune pnpm store and apt caches to free space..."
            pnpm store prune || true
            rm -rf ~/.npm || true
            apt-get clean -y || true
            rm -rf /var/lib/apt/lists/* || true

      - name: Tail PM2 logs (last 120 lines)
        if: always()
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.LINODE_HOST }}
          username: ${{ secrets.LINODE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: false
          command_timeout: 5m
          script: |
            pm2 logs voice-backend --lines 120 --nostream || true



// File: frontend/src/components/voice-input/styles/voice-input.scss
/**
 * @file voice-input.scss
 * @description Consolidated and themed styles for the Voice Input component.
 * Includes geometric patterns, state-based animations, "listening but ignoring" effects,
 * and adheres to the "Ephemeral Harmony" design system.
 * @version 3.2.0 - Fixed SCSS errors, defined button-base mixin, refined theme application.
 */

@use '@/styles/abstracts/variables' as var;
@use '@/styles/abstracts/mixins' as mixins;

// -----------------------------------------------------------------------------
// Main Voice Input Wrapper
// -----------------------------------------------------------------------------
.voice-input-wrapper {
  position: relative;
  background-color: hsla(
    var(--color-bg-secondary-h, var.$default-color-bg-secondary-h),
    var(--color-bg-secondary-s, var.$default-color-bg-secondary-s),
    var(--color-bg-secondary-l, var.$default-color-bg-secondary-l),
    var(--opacity-voice-input-wrapper-bg, 0.92) // Use CSS var for opacity
  );
  backdrop-filter: blur(var(--blur-voice-input-wrapper, var.$spacing-md)); // Use CSS var for blur
  border-radius: var.$radius-xl;
  padding: var.$spacing-md var.$spacing-lg;
  // overflow: hidden; // Reverted to visible to allow for more expansive glow effects if desired by themes
  overflow: visible;
  transition: background-color var.$duration-smooth var.$ease-out-cubic,
              opacity var.$duration-smooth var.$ease-out-cubic,
              box-shadow var.$duration-smooth var.$ease-out-cubic; // Add box-shadow to transition
  box-shadow: var(--shadow-voice-input-wrapper, var.$shadow-depth-md); // Use CSS var for shadow

  opacity: 1;

  &.state-stt-active {
    background-color: hsla(
      var(--color-bg-secondary-h, var.$default-color-bg-secondary-h),
      calc(var(--color-bg-secondary-s, var.$default-color-bg-secondary-s) + 5%), // Subtle saturation boost
      calc(var(--color-bg-secondary-l, var.$default-color-bg-secondary-l) + 3%), // Subtle lightness boost
      var(--opacity-voice-input-wrapper-bg-active, 0.98)
    );
    // Example of a themeable inner glow for active STT
    box-shadow: inset 0 0 10px -2px hsla(var(--color-voice-user-h, var.$default-color-voice-user-h), var(--color-voice-user-s, var.$default-color-voice-user-s), var(--color-voice-user-l, var.$default-color-voice-user-l), 0.25),
                var(--shadow-voice-input-wrapper-active, var.$shadow-depth-lg); // Potentially deeper shadow
  }

  &.state-llm-processing {
    opacity: var(--opacity-voice-input-llm-processing, 0.92);
    // Optional: Add a very subtle border pulse or pattern change
  }

  &.state-vad-listening { // VAD listening for WAKE WORD
    background-color: hsla(
      var(--color-bg-tertiary-h, var.$default-color-bg-tertiary-h),
      var(--color-bg-tertiary-s, var.$default-color-bg-tertiary-s),
      var(--color-bg-tertiary-l, var.$default-color-bg-tertiary-l),
      var(--opacity-voice-input-wrapper-vad, 0.95)
    );
     box-shadow: inset 0 0 12px -3px hsla(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l), 0.2),
                var(--shadow-voice-input-wrapper-vad, var.$shadow-depth-lg);
  }
}

// -----------------------------------------------------------------------------
// Background Effects (Geometric Pattern, Dynamic Gradient)
// -----------------------------------------------------------------------------
.geometric-pattern-bg,
.dynamic-gradient-bg {
  position: absolute;
  pointer-events: none;
  transition: opacity var.$duration-smooth ease-in-out;
  border-radius: inherit; // Ensure effects adhere to the wrapper's border radius
}

.geometric-pattern-bg {
  inset: calc(-1 * var.$spacing-xl * 2); // Make inset configurable or use larger unit
  width: calc(100% + (var.$spacing-xl * 4));
  height: calc(100% + (var.$spacing-xl * 4));
  z-index: 0;
  opacity: var(--opacity-geometric-pattern-idle, 0.03); // Default very subtle

  .pattern-stroke {
    stroke: hsl(var(--color-accent-primary-h), var(--color-accent-primary-s), var(--color-accent-primary-l));
    stroke-width: var(--stroke-width-geometric-pattern, 0.5px);
    transition: stroke var.$duration-smooth ease-in-out;
  }

  .voice-input-wrapper.state-stt-active & {
    opacity: var(--opacity-geometric-pattern-stt-active, 0.1);
    .pattern-stroke { stroke: hsl(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l)); }
  }
  .voice-input-wrapper.state-llm-processing & {
    opacity: var(--opacity-geometric-pattern-llm-processing, 0.02);
    .pattern-stroke { stroke: hsl(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l)); }
  }
  .voice-input-wrapper.state-vad-listening & {
    opacity: var(--opacity-geometric-pattern-vad-listening, 0.08);
    .pattern-stroke { stroke: hsl(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l)); }
  }
}

.dynamic-gradient-bg {
  inset: 0;
  z-index: 1;
  opacity: 0; // Controlled by JS via `backgroundGradient.value` in `VoiceInput.vue` for specific states
  // Example: background: var(--gradient-voice-input-active, none);
  // The JS will set the `background` style directly. This class ensures it's visible when opacity is set by JS (though JS sets style.background directly).
  // For a CSS-only animated gradient, one would define it here and control opacity.
  // Since JS controls the `background` property, this opacity is mostly for fade-in/out if desired.
  .voice-input-wrapper.state-stt-active &,
  .voice-input-wrapper.state-vad-listening &,
  .voice-input-wrapper.state-llm-processing & {
     opacity: var(--opacity-dynamic-gradient-active, 0.8); // Make the gradient itself somewhat transparent
  }
}

// -----------------------------------------------------------------------------
// Ignored Text Container & Animation
// -----------------------------------------------------------------------------
.ignored-text-container {
  // (Styles from v3.1.0 were good, no major changes needed, ensure z-index and positioning are optimal)
  position: absolute;
  top: var.$spacing-xs; // Position from top
  left: 0; right: 0;
  height: 40%; // Limit height to prevent overlap with controls
  pointer-events: none;
  z-index: 5;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.ignored-text {
  // (Styles from v3.1.0 are good)
  position: relative;
  color: hsla( var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l), 0.6 );
  font-size: var.$font-size-xs;
  font-style: italic;
  white-space: nowrap;
  padding: 2px 6px;
  margin-bottom: 3px;
  background-color: hsla(var(--color-bg-primary-h), var(--color-bg-primary-s), var(--color-bg-primary-l), 0.2);
  border-radius: var.$radius-sm;
  animation: fadeUpAndOut 2.2s ease-out forwards; // Slightly adjusted duration
}
// @keyframes fadeUpAndOut remains the same

// -----------------------------------------------------------------------------
// Voice Visualization Canvas
// -----------------------------------------------------------------------------
.voice-visualization-canvas {
  position: absolute;
  // Default position: subtly above the input area, centered
  bottom: calc(100% - #{var.$spacing-sm}); // Closer to the top edge of the input area
  left: 50%;
  transform: translateX(-50%);
  width: var(--width-viz-canvas-default, 150px);
  height: var(--height-viz-canvas-default, 35px);
  opacity: 0;
  transition: all var.$duration-smooth var.$ease-out-expo, opacity var.$duration-quick var.$ease-out-quad; // Separate opacity transition
  pointer-events: none;
  z-index: 2; // Above background effects, below input area
  filter: drop-shadow(0 1px 3px hsla(var(--color-shadow-h), var(--color-shadow-s), var(--color-shadow-l), 0.15));

  &.prominent {
    opacity: var(--opacity-viz-canvas-prominent, 0.85); // Allow theme to control final opacity
    width: clamp(180px, 40vw, 280px); // Responsive prominent width
    height: clamp(50px, 12vh, 80px);   // Responsive prominent height
    top: 50%;
    bottom: auto;
    transform: translate(-50%, -50%);
    z-index: 3; // Above other effects, potentially below a modal/dropdown from toolbar
    filter: drop-shadow(0 3px 8px hsla(var(--color-shadow-h), var(--color-shadow-s), var(--color-shadow-l), 0.2));
  }

  .voice-input-wrapper.state-llm-processing &.prominent {
    opacity: var(--opacity-viz-canvas-llm-processing, 0.3); // Muted when LLM is busy
  }
}

// -----------------------------------------------------------------------------
// Input Area (Textarea + Send Button)
// -----------------------------------------------------------------------------
.input-area {
  position: relative;
  display: flex;
  align-items: flex-end;
  gap: var.$spacing-sm;
  z-index: 10; // Forefront
}

.voice-textarea {
  flex: 1;
  min-height: var(--height-voice-textarea-min, 44px); // Align with typical button height + padding
  max-height: var(--height-voice-textarea-max, 160px);
  background-color: hsla(
    var(--color-bg-input-h, var.$default-color-bg-primary-h),      // Themeable input background
    var(--color-bg-input-s, var.$default-color-bg-primary-s),
    var(--color-bg-input-l, calc(var.$default-color-bg-primary-l + 2%)), // Slightly distinct
    var(--opacity-voice-textarea-bg, 0.9)
  );
  color: hsl(var(--color-text-input-h, var.$default-color-text-primary-h), var(--color-text-input-s, var.$default-color-text-primary-s), var(--color-text-input-l, var.$default-color-text-primary-l));
  border: 1px solid hsla(
    var(--color-border-input-h, var.$default-color-border-primary-h),
    var(--color-border-input-s, var.$default-color-border-primary-s),
    var(--color-border-input-l, var.$default-color-border-primary-l),
    var(--opacity-voice-textarea-border, 0.65)
  );
  border-radius: var.$radius-md;
  padding: calc(var.$spacing-sm - 1px) var.$spacing-md; // Fine-tune padding
  font-family: var.$font-family-sans;
  font-size: var.$font-size-base-default; // CORRECTED
  line-height: var.$line-height-base-default;
  resize: none;
  transition: background-color var.$duration-quick var.$ease-out-quad,
              border-color var.$duration-quick var.$ease-out-quad,
              box-shadow var.$duration-quick var.$ease-out-quad;
  overflow-y: auto;
  @include mixins.custom-scrollbar(
    '--color-accent-interactive', 0.35, 0.55, '--color-bg-input', 0.15, 5px, var.$radius-sm
  );

  &::placeholder {
    color: hsl(var(--color-text-placeholder-h, var.$default-color-text-muted-h), var(--color-text-placeholder-s, var.$default-color-text-muted-s), var(--color-text-placeholder-l, var.$default-color-text-muted-l));
    opacity: var(--opacity-voice-textarea-placeholder, 0.7);
    transition: opacity var.$duration-quick ease-out;
  }

  &:focus {
    outline: none;
    background-color: hsla(
      var(--color-bg-input-focused-h, var.$default-color-bg-primary-h),
      var(--color-bg-input-focused-s, var.$default-color-bg-primary-s),
      var(--color-bg-input-focused-l, var.$default-color-bg-primary-l),
      var(--opacity-voice-textarea-bg-focused, 0.98)
    );
    border-color: hsl(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l));
    @include mixins.focus-ring(
        '--color-bg-input-focused-for-ring', // Usually same as input focused bg
        '--color-accent-interactive',
        1px, 2px, 0.85
    );
     &::placeholder { opacity: var(--opacity-voice-textarea-placeholder-focused, 0.5); }
  }

  &:disabled {
    opacity: var(--opacity-voice-textarea-disabled, 0.65);
    cursor: not-allowed;
    background-color: hsla(
        var(--color-bg-input-disabled-h, var.$default-color-bg-secondary-h),
        var(--color-bg-input-disabled-s, var.$default-color-bg-secondary-s),
        var(--color-bg-input-disabled-l, var.$default-color-bg-secondary-l),
        var(--opacity-voice-textarea-bg-disabled, 0.5)
    );
  }

  .voice-input-wrapper.state-llm-processing & {
    background-color: hsla(
      var(--color-bg-input-llm-processing-h, var.$default-color-bg-primary-h),
      var(--color-bg-input-llm-processing-s, var.$default-color-bg-primary-s),
      var(--color-bg-input-llm-processing-l, calc(var.$default-color-bg-primary-l * 0.95)),
      var(--opacity-voice-textarea-bg-llm-processing, 0.65)
    );
    border-color: hsla(
        var(--color-border-input-llm-processing-h, var.$default-color-border-primary-h),
        var(--color-border-input-llm-processing-s, var.$default-color-border-primary-s),
        var(--color-border-input-llm-processing-l, var.$default-color-border-primary-l),
        var(--opacity-voice-textarea-border-llm-processing, 0.4)
    );
    &::placeholder { animation: pulsePlaceholder var.$duration-pulse-medium var.$ease-in-out-sine infinite; }
  }
}
// @keyframes pulsePlaceholder remains the same

// -----------------------------------------------------------------------------
// Buttons (Send, Mic, Control)
// -----------------------------------------------------------------------------
.send-button,
.mic-button {
  @include mixins.button-base; // Use the new base mixin
  flex-shrink: 0; // Prevent buttons from shrinking
  color: hsl(var(--color-text-on-primary-h), var(--color-text-on-primary-s), var(--color-text-on-primary-l)); // Default icon/text color for these buttons
  box-shadow: var(--shadow-button-idle, var.$scss-box-shadow-sm); // Subtle default shadow

  &:hover:not(:disabled) {
    transform: translateY(-1px) scale(1.03); // Combined hover effect
    box-shadow: var(--shadow-button-hover, var.$scss-box-shadow-md);
  }
  &:active:not(:disabled) {
    transform: translateY(0px) scale(0.99); // Combined active effect
    box-shadow: var(--shadow-button-active, var.$scss-box-shadow-xs); // Inset-like shadow
  }
}

.send-button {
  width: var(--size-send-button, 44px); // Use CSS var for size
  height: var(--size-send-button, 44px);
  background: linear-gradient( var(--angle-send-button-bg, 135deg),
    hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), var(--opacity-send-button-bg, 0.95)),
    hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), calc(var(--color-accent-secondary-l) * 0.88), var(--opacity-send-button-bg, 0.95))
  );
  border-radius: var.$radius-md;
  .icon { width: 20px; height: 20px; transition: transform var.$duration-quick var.$ease-elastic; }

  &:hover:not(:disabled) {
    background: linear-gradient( var(--angle-send-button-bg-hover, 135deg),
        hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), calc(var(--color-accent-secondary-l) * 1.03), 1),
        hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 1)
    );
    .icon { transform: rotate(-8deg) scale(1.12); }
  }
}

.mic-button {
  width: var(--size-mic-button, 48px);
  height: var(--size-mic-button, 48px);
  background: linear-gradient( var(--angle-mic-button-bg, 135deg),
    hsla(var(--color-accent-primary-h), var(--color-accent-primary-s), var(--color-accent-primary-l), var(--opacity-mic-button-bg, 0.95)),
    hsla(var(--color-accent-primary-h), var(--color-accent-primary-s), calc(var(--color-accent-primary-l) * 0.88), var(--opacity-mic-button-bg, 0.95))
  );
  border-radius: 50%;
  position: relative;
  overflow: hidden; // Keep ripple contained
  .icon { width: 24px; height: 24px; transition: transform var.$duration-quick var.$ease-elastic; }

  &:hover:not(:disabled) {
     background: linear-gradient( var(--angle-mic-button-bg-hover, 135deg),
        hsla(var(--color-accent-primary-h), var(--color-accent-primary-s), calc(var(--color-accent-primary-l) * 1.03), 1),
        hsla(var(--color-accent-primary-h), var(--color-accent-primary-s), var(--color-accent-primary-l), 1)
    );
  }

  &.listening, &.vad_listening.active-command { // Common style for active audio capture (PTT, Cont, VAD Command)
    background: linear-gradient( var(--angle-mic-button-listening-bg, 135deg),
      hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), var(--opacity-mic-button-listening-bg, 0.98)),
      hsla(var(--color-voice-user-h), var(--color-voice-user-s), calc(var(--color-voice-user-l) * 0.88), var(--opacity-mic-button-listening-bg, 0.98))
    );
    animation: micPulse var.$duration-pulse-medium var.$ease-in-out-sine infinite alternate;
    &::before { // Ripple for active capture
      content: ''; position: absolute; inset: 0; border-radius: 50%;
      box-shadow: 0 0 0 0 hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), var(--opacity-mic-ripple, 0.6));
      animation: micRipple var.$duration-pulse-medium ease-out infinite; // Sync with micPulse
      pointer-events: none;
    }
  }
  &.vad_listening { // VAD wake word listening specifically (subtler)
    background: linear-gradient( var(--angle-mic-button-vad-bg, 135deg),
      hsla(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l), var(--opacity-mic-button-vad-bg, 0.85)),
      hsla(var(--color-accent-interactive-h), var(--color-accent-interactive-s), calc(var(--color-accent-interactive-l) * 0.75), var(--opacity-mic-button-vad-bg, 0.85))
    );
    animation: micPulse var.$duration-pulse-slow var.$ease-in-out-sine infinite alternate; // Slower pulse
    &::before { // Softer ripple for VAD wake
       box-shadow: 0 0 0 0 hsla(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l), var(--opacity-mic-ripple-vad, 0.4));
       animation-duration: var.$duration-pulse-slow;
    }
  }
  &.error {
    background: linear-gradient( var(--angle-mic-button-error-bg, 135deg),
      hsla(var(--color-error-h), var(--color-error-s), var(--color-error-l), var(--opacity-mic-button-error-bg, 0.9)),
      hsla(var(--color-error-h), var(--color-error-s), calc(var(--color-error-l) * 0.8), var(--opacity-mic-button-error-bg, 0.9))
    );
    animation: errorShake 0.4s var.$ease-in-out-quad;
  }
}
// Keyframes micRipple, micPulse, errorShake remain good from v3.1.0

// -----------------------------------------------------------------------------
// Controls Row & Status Display
// -----------------------------------------------------------------------------
// .controls-row, .status-display, .mode-indicator styles from v3.1.0 were good.
// .mode-dot and its animations (dotPulseActive, etc.) from v3.1.0 were good.
// .recording-status from v3.1.0 was good.

.control-btn {
  @include mixins.button-ghost(
    '--color-text-muted', // Muted text color for control buttons
    '--color-accent-interactive', // Interactive color on hover/focus
    var.$spacing-xs, // Padding
    var.$radius-md // Border radius
  );
  .icon-sm { width: var(--size-icon-sm-control-btn, 1.125rem); height: var(--size-icon-sm-control-btn, 1.125rem); }
}
// .secondary-controls styles from v3.1.0 were good.
// .toolbar-slide-* transitions from v3.1.0 were good.

.secondary-controls {
  display: flex;
  align-items: center; // Vertically align items in this group
  gap: var.$spacing-xs; // Space between control buttons
  margin-left: auto; // Push to the right if status-display doesn't fill all space
}

.control-btn { // Style for toolbar trigger, history button etc.
  @include mixins.button-ghost; // Assuming this mixin provides transparent bg, themed text/icon color
  padding: var.$spacing-xs; // Adequate touch target
  border-radius: var.$radius-md;
  color: hsl(var(--color-text-secondary-h), var(--color-text-secondary-s), var(--color-text-secondary-l));

  .icon-sm { // Standard size for these icons
    width: 1.125rem; // 18px
    height: 1.125rem;
  }

  &:hover:not(:disabled) {
    background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.7);
    color: hsl(var(--color-text-primary-h), var(--color-text-primary-s), var(--color-text-primary-l));
  }
}

// -----------------------------------------------------------------------------
// Input Toolbar Transition (Keep as is, good)
// -----------------------------------------------------------------------------
.toolbar-slide-enter-active,
.toolbar-slide-leave-active {
  transition: all var.$duration-smooth var.$ease-out-expo; // Use smoother ease
}
.toolbar-slide-enter-from {
  opacity: 0;
  transform: translateY(15px) scale(0.98); // Slightly less movement
}
.toolbar-slide-leave-to {
  opacity: 0;
  transform: translateY(10px) scale(0.98);
}
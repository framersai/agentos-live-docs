// File: frontend/src/styles/components/_message.scss
/**
 * @file _message.scss
 * @description Styles for the Message.vue component, Ephemeral Harmony theme.
 * Features holographic/glassmorphic message bubbles, enhanced typography,
 * and clear distinction between sender roles.
 * @version 3.0.0
 */

@use '../abstracts/variables' as var;
@use '../abstracts/mixins' as mixins;

.message-wrapper-ephemeral {
  display: flex;
  margin-bottom: var.$spacing-md; // Space between messages
  opacity: 0; // Start hidden for entry animation
  animation: ephemeralMessageIn var.$duration-movement var.$ease-out-quint forwards;

  // General alignment and max-width for bubbles
  &.user-message-wrapper {
    justify-content: flex-end;
    .message-container-ephemeral {
      margin-left: auto; // Pushes bubble to the right
      max-width: 85%;
      @media (min-width: var.$breakpoint-sm) { max-width: 75%; }
      @media (min-width: var.$breakpoint-lg) { max-width: 65%; }
    }
  }

  &.assistant-message-wrapper,
  &.tool-message-wrapper, // Tool messages often originate from assistant action
  &.system-message-wrapper,
  &.error-message-wrapper {
    justify-content: flex-start;
    .message-container-ephemeral {
      margin-right: auto; // Pushes bubble to the left
      max-width: 85%;
       @media (min-width: var.$breakpoint-sm) { max-width: 75%; }
      @media (min-width: var.$breakpoint-lg) { max-width: 65%; }
    }
  }
}

.message-container-ephemeral {
  padding: calc(var.$spacing-sm * 1.25) var.$spacing-md;
  border-radius: var.$radius-xl; // Generous radius
  position: relative;
  overflow: hidden; // For pseudo-elements and effects
  transition: transform 0.2s var.$ease-out-quad, box-shadow 0.3s var.$ease-out-quad;

  // Base glassmorphic look for all bubbles
  @include mixins.glassmorphic-pane(
    hsla(var(--color-bg-secondary-h), var(--color-bg-secondary-s), var(--color-bg-secondary-l), 0.5), // Base glass bg
    hsla(var(--color-border-glass-h), var(--color-border-glass-s), var(--color-border-glass-l), 0.3), // Base glass border
    var(--blur-glass),
    var(--shadow-depth-sm) // Base subtle shadow
  );

  &:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-depth-md); // Slightly lift on hover
  }
}

// Role-specific bubble styling
.user-bubble-ephemeral {
  background-color: hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.15);
  border-color: hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.3);
  // Optional: A subtle right-aligned holographic accent for user messages
  &::after {
    content: '';
    position: absolute;
    top: 0; bottom: 0; right: -1px;
    width: 3px;
    background: linear-gradient(to bottom,
      hsla(var(--color-voice-user-h), var(--color-voice-user-s), calc(var(--color-voice-user-l) + 10%), 0.5),
      hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.8)
    );
    border-radius: 0 var.$radius-xl var.$radius-xl 0;
    opacity: 0.6;
    filter: blur(1px);
  }
}

.assistant-bubble-ephemeral {
  background-color: hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.1);
  border-color: hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.25);
  // Holographic accent for AI messages
  @include mixins.holographic-border-glow(
    '--color-voice-ai-speaking', // Uses -h, -s, -l, -a from this prefix
    '--color-accent-secondary', // Secondary color for gradient mix
    1px, // border-width
    4s,  // animation-duration
    var.$radius-xl // border-radius
  );
}

.tool-bubble-ephemeral {
  background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.6);
  border-color: hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.4);
  border-left-width: 3px;
  border-left-color: hsl(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l));
}

.system-error-bubble-ephemeral { // For system and error messages
  background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.4);
  border-color: hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.3);
  font-style: italic;
  font-size: var.$font-size-sm;

  &.message-role-error { // Specifically for error messages
    background-color: hsla(var(--color-error-h), var(--color-error-s), var(--color-error-l), 0.1);
    border-color: hsla(var(--color-error-h), var(--color-error-s), var(--color-error-l), 0.3);
    color: hsl(var(--color-error-h), var(--color-error-s), calc(var(--color-error-l) + 5%)); // Ensure text is readable
  }
}


.message-header-ephemeral {
  display: flex;
  align-items: center;
  margin-bottom: var.$spacing-sm;
  gap: var.$spacing-sm;
}

.avatar-wrapper-ephemeral {
  width: 32px; // Increased size
  height: 32px;
  border-radius: var.$radius-full;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.5);
  border: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.3);
  box-shadow: var(--shadow-depth-xs); // SCSS variable fallback if CSS var not set

  &.avatar-user { background-color: hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.2); }
  &.avatar-assistant { background-color: hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.2); }
  &.avatar-tool { background-color: hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 0.2); }
  &.avatar-system, &.avatar-error { background-color: hsla(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l), 0.2); }
  &.avatar-error { background-color: hsla(var(--color-error-h), var(--color-error-s), var(--color-error-l), 0.2); }

  .avatar-svg-ephemeral {
    width: 18px; // Icon size within avatar
    height: 18px;
    opacity: 0.9;
    // Colors will be inherited or can be set per role
    color: hsl(var(--color-text-primary-h), var(--color-text-primary-s), var(--color-text-primary-l));
  }
}

.sender-name-ephemeral {
  font-weight: 600;
  font-size: var.$font-size-sm; // Slightly larger sender name
  color: hsl(var(--color-text-primary-h), var(--color-text-primary-s), var(--color-text-primary-l));
  letter-spacing: 0.01em;
}

.timestamp-ephemeral {
  font-size: var.$font-size-xs;
  color: hsl(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l));
  margin-left: auto; // Pushes timestamp to the right of the header
  padding-left: var.$spacing-sm;
}

.message-content-area-ephemeral {
  font-size: var(--font-size-base); // Use themed base font size
  line-height: var(--line-height-base); // Use themed base line height
  letter-spacing: var(--letter-spacing-base); // Use themed base letter spacing
  color: hsl(var(--color-text-secondary-h), var(--color-text-secondary-s), var(--color-text-secondary-l));
  word-wrap: break-word;
  overflow-wrap: break-word;

  // Enhanced prose styles for markdown content
  // Tailwind's @tailwindcss/typography plugin is good, but we can add specifics
  :deep(h1), :deep(h2), :deep(h3), :deep(h4) { // Using :deep for slotted/v-html content
    color: hsl(var(--color-text-primary-h), var(--color-text-primary-s), var(--color-text-primary-l)) !important;
    margin-top: var.$spacing-md !important;
    margin-bottom: var.$spacing-sm !important;
    padding-bottom: var.$spacing-xs !important;
    border-bottom: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.3) !important;
  }
  :deep(p) {
    margin-bottom: var.$spacing-sm !important;
    line-height: 1.75; // More readable line height for prose
  }
  :deep(ul), :deep(ol) {
    margin-left: 0 !important;
    padding-left: var.$spacing-lg !important;
    li { margin-bottom: calc(var.$spacing-xs / 2) !important; }
    li::marker {
      color: hsl(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l)) !important;
    }
  }
  :deep(a) {
    color: hsl(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l)) !important;
    text-decoration: underline;
    text-underline-offset: 2px;
    font-weight: 500;
    &:hover {
      color: hsl(var(--color-accent-interactive-h), calc(var(--color-accent-interactive-s) + 5%), calc(var(--color-accent-interactive-l) - 8%)) !important;
    }
  }
  :deep(code:not(pre code)) { // Inline code
    background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.6) !important;
    color: hsl(var(--color-text-accent-h), var(--color-text-accent-s), var(--color-text-accent-l)) !important;
    padding: 0.15em 0.4em !important;
    border-radius: var.$radius-sm !important;
    font-size: 0.9em !important; // Relative to surrounding text
    border: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.3) !important;
  }
  :deep(pre) {
    background-color: hsla(var(--color-bg-primary-h), var(--color-bg-primary-s), calc(var(--color-bg-primary-l) + 3%), 0.8) !important; // Slightly different from bubble bg
    border: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.2) !important;
    border-radius: var.$radius-lg !important;
    padding: var.$spacing-md !important;
    margin: var.$spacing-md 0 !important;
    box-shadow: inset 0 2px 8px hsla(var(--shadow-color-h), var(--color-shadow-s), var(--color-shadow-l), 0.1);
    code {
      font-size: 0.9em !important; // Relative to pre
      line-height: 1.6; // Good for code readability
    }
  }

  // Line numbers and copy button styling (from Message.vue's dynamic creation)
  .code-block-wrapper {
    position: relative;
    margin: var.$spacing-md 0;
    border-radius: var.$radius-lg;
    overflow: hidden; // For rounded corners on pre
    background-color: hsla(var(--color-bg-primary-h), var(--color-bg-primary-s), calc(var(--color-bg-primary-l) + 3%), 0.8);
    border: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.2);

    .code-language-label {
      position: absolute;
      top: var.$spacing-xs;
      right: var.$spacing-md + 36px; // Space for copy button
      font-size: var.$font-size-xs;
      font-family: var(--font-mono);
      color: hsl(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l));
      padding: 2px var.$spacing-xs;
      background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.5);
      border-radius: var.$radius-sm;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .copy-code-button {
      position: absolute;
      top: var.$spacing-xs;
      right: var.$spacing-xs;
      padding: calc(var.$spacing-xs / 2);
      border-radius: var.$radius-sm;
      background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.5);
      color: hsl(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l));
      border: 1px solid transparent;
      opacity: 0.6;
      transition: opacity 0.2s, background-color 0.2s, color 0.2s, border-color 0.2s;
      &:hover {
        opacity: 1;
        background-color: hsla(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l), 0.2);
        color: hsl(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l));
        border-color: hsla(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l), 0.3);
      }
      svg { width: 16px; height: 16px; }
    }

    pre {
      margin: 0 !important; // Reset margin if set by prose
      padding-top: calc(var.$spacing-md + var.$spacing-sm) !important; // Space for lang/copy button
      padding-left: var.$spacing-sm !important; // Minimal left padding for line numbers
      background-color: transparent !important; // Wrapper has background
      border: none !important;
      box-shadow: none !important;

      .line-number {
        display: inline-block;
        width: 2.5em; // Space for up to 3-digit line numbers
        text-align: right;
        padding-right: var.$spacing-sm;
        margin-right: var.$spacing-sm;
        color: hsla(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l), 0.5);
        border-right: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.2);
        user-select: none; // Prevent selection of line numbers
        position: sticky; // If pre is scrollable horizontally
        left: 0;
        background-color: inherit; // Match pre background
      }
      .line-content {
        // Content of the line
      }
    }
  }

  // Diagram placeholder/viewer
  .diagram-placeholder-ephemeral {
    font-style: italic;
    color: hsl(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l));
    padding: var.$spacing-sm 0;
  }
  .embedded-diagram-viewer {
    margin-top: var.$spacing-md;
    // DiagramViewer itself will have styles from _diagram-viewer.scss
  }
}

// Tool specific display
.tool-content-display {
  :deep(pre) {
    // Specific styling for JSON output from tools
    background-color: hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 0.05) !important;
    border-color: hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 0.15) !important;
    code.language-json .hljs-string {
      color: hsl(var(--color-success-h), var(--color-success-s), calc(var(--color-success-l) + 10%)) !important; // Brighter strings for JSON
    }
  }
}

// Message entry animation from _keyframes.scss
// @keyframes ephemeralMessageIn { ... }
// File: frontend/src/styles/components/_message.scss
/**
 * @file _message.scss
 * @description Styles for the Message.vue component, "Ephemeral Harmony" theme.
 * Features distinct, visually rich message bubbles with neomorphic and holographic
 * influences, enhanced typography, and clear code block styling.
 * @version 4.0.0 - Full Ephemeral Harmony redesign for message components.
 */

@use '../abstracts/variables' as var;
@use '../abstracts/mixins' as mixins;
@use './buttons' as buttonsFile; // For copy button & potential interactive elements

.message-wrapper-ephemeral {
  display: flex;
  margin-bottom: var.$spacing-lg; // Increased default spacing between messages
  opacity: 0;
  animation: messageAppear var.$duration-movement var.$ease-out-quint 0.1s forwards; // Slight delay for entry

  // Alignment based on role
  &.user-message-wrapper {
    justify-content: flex-end;
    .message-container-ephemeral { margin-left: auto; } // Standard alignment
    // For a more dynamic/offset look, could use:
    // padding-left: var.$spacing-2xl; // Push user messages further right by default
  }

  &.assistant-message-wrapper,
  &.tool-message-wrapper,
  &.system-message-wrapper,
  &.error-message-wrapper {
    justify-content: flex-start;
    .message-container-ephemeral { margin-right: auto; } // Standard alignment
    // padding-right: var.$spacing-2xl; // Push AI/system messages further left
  }
}

.message-container-ephemeral {
  padding: calc(var.$spacing-sm * 1.2) var.$spacing-md;
  border-radius: var.$radius-xl;
  position: relative;
  overflow: visible; // Allow for outset glows
  max-width: 80%;
  transition: transform 0.25s var.$ease-out-expo, box-shadow 0.3s var.$ease-out-expo;
  will-change: transform, box-shadow;

  @media (min-width: var.$breakpoint-sm) { max-width: 75%; }
  @media (min-width: var.$breakpoint-lg) { max-width: 70%; }

  // Subtle hover lift for all messages
  &:hover {
    transform: translateY(-2px);
  }
}

// --- Role-Specific Bubble Styling ---

// User Messages: Solid, slightly tactile, personal feel
.user-bubble-ephemeral {
  // Use neomorphic extrude with user's voice color as a base for the background
  // This implies your theme needs to define --color-voice-user-h/s/l
  @include mixins.neomorphic-extrude(
    '--color-voice-user', // CSS Variable prefix for background (e.g., --color-voice-user-h/s/l)
    4px, 10px, // distance, blur
    '--shadow-opacity-soft', // shadow opacity var
    var.$radius-xl,
    '--shadow-color-h', '--shadow-color-s', '--shadow-color-l', '--shadow-highlight-modifier',
    // Fallbacks if CSS vars for user voice color aren't set for background purposes
    var.$default-color-bg-secondary-h, calc(var.$default-color-bg-secondary-s) + 5%, calc(var.$default-color-bg-secondary-l) - 5%, // Example: slightly tinted secondary bg
    var.$default-shadow-opacity-soft,
    var.$default-shadow-color-h, var.$default-shadow-color-s, var.$default-shadow-color-l,
    var.$default-shadow-highlight-l-factor
  );
  // Override background if neomorphic extrude uses a generic one
  background-color: hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.12);
  border: 1px solid hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.25);

  .message-header-ephemeral .sender-name-ephemeral {
    color: hsl(var(--color-voice-user-h), var(--color-voice-user-s), calc(var(--color-voice-user-l) - 20%)); // Darker, saturated user color
  }
  &:hover { // More pronounced shadow on hover for user message
     box-shadow: 6px 6px 14px hsla(var(--shadow-color-h), var(--shadow-color-s), var(--shadow-color-l), calc(var(--shadow-opacity-soft) * 1.3)),
                -6px -6px 14px hsla(var(--shadow-color-h), var(--shadow-color-s), calc(var(--shadow-color-l) + var(--shadow-highlight-modifier)), calc(var(--shadow-opacity-soft) * 1.3)),
                0 0 10px hsla(var(--color-voice-user-h),var(--color-voice-user-s),var(--color-voice-user-l),0.2); // User color glow
  }
}

// Assistant Messages: Sleek glass, holographic accents
.assistant-bubble-ephemeral {
  @include mixins.glassmorphic-pane(
    '--color-voice-ai-speaking', // Use AI voice color with low alpha for glass background
    '--color-voice-ai-speaking', // Use AI voice color for border
    calc(var(--blur-glass) * 0.9), // Slightly less blur than default glass
    '--shadow-depth-md', // Standard depth shadow
    // Fallbacks
    var.$default-color-voice-ai-speaking-h, var.$default-color-voice-ai-speaking-s, var.$default-color-voice-ai-speaking-l, 0.15, // Low alpha AI voice color for BG
    var.$default-color-voice-ai-speaking-h, var.$default-color-voice-ai-speaking-s, var.$default-color-voice-ai-speaking-l, 0.3,  // Slightly more opaque border
    calc(var.$default-blur-glass) * 0.9,
    var.$scss-box-shadow-md
  );
  
  @include mixins.holographic-border-glow(
    '--color-voice-ai-speaking', // Primary glow: AI voice color
    '--color-accent-interactive',  // Secondary glow: Interactive accent
    1px, // border-width
    3.5s, // animation-duration
    var.$radius-xl // border-radius
  );

  .message-header-ephemeral .sender-name-ephemeral {
    color: hsl(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), calc(var(--color-voice-ai-speaking-l) - 15%));
  }
   &:hover { // Enhance holographic effect on hover
     box-shadow: var(--shadow-depth-lg), // Deeper base shadow
                 0 0 25px 3px hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.35); // Stronger glow
   }
}

// Tool Messages: Distinct, functional, inset style
.tool-bubble-ephemeral {
  @include mixins.neomorphic-inset(
    '--color-bg-tertiary', 5px, 3px, '--shadow-opacity-soft', var.$radius-lg,
    '--shadow-color-h', '--shadow-color-s', '--shadow-color-l', '--shadow-highlight-modifier',
    var.$default-color-bg-tertiary-h, var.$default-color-bg-tertiary-s, var.$default-color-bg-tertiary-l,
    var.$default-shadow-opacity-soft, var.$default-shadow-color-h, var.$default-shadow-color-s, var.$default-shadow-color-l, var.$default-shadow-highlight-l-factor
  );
  border: 1px solid hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 0.3);
  border-left: 4px solid hsl(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l));
  padding-left: calc(var.$spacing-md - 2px);

  .message-header-ephemeral .sender-name-ephemeral {
    color: hsl(var(--color-accent-secondary-h), var(--color-accent-secondary-s), calc(var(--color-accent-secondary-l) - 20%));
  }
}

// System & Error Messages
.system-error-bubble-ephemeral {
  background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.5); // More opaque than ephemeral log
  border: 1px dashed hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.6);
  color: hsl(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l));
  font-style: italic;
  font-size: var.$font-size-sm; // Slightly larger than ephemeral
  padding: var.$spacing-sm var.$spacing-md;
  box-shadow: var(--shadow-depth-xs);

  &.message-role-error {
    background-color: hsla(var(--color-error-h), var(--color-error-s), var(--color-error-l), 0.12);
    border-color: hsla(var(--color-error-h), var(--color-error-s), var(--color-error-l), 0.5);
    border-style: solid;
    color: hsl(var(--color-error-h), var(--color-error-s), calc(var(--color-error-l) + 5%));
    font-style: normal;
    .message-header-ephemeral .sender-name-ephemeral {
        color: hsl(var(--color-error-h), var(--color-error-s), calc(var(--color-error-l) - 10%));
    }
  }
}


// --- Message Header & Avatar ---
.message-header-ephemeral {
  display: flex;
  align-items: center;
  margin-bottom: calc(var.$spacing-sm * 1.25); // More space below header
  gap: var.$spacing-sm;
}

.avatar-wrapper-ephemeral {
  width: 38px; // Slightly larger avatar
  height: 38px;
  border-radius: var.$radius-full;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  // Neomorphic inset for the avatar pod itself
  @include mixins.neomorphic-inset(
    '--color-bg-primary', // Base color for inset effect
    3px, 2px, // blur, distance
    '--shadow-opacity-soft', // opacity var
    var.$radius-full,
    '--shadow-color-h', '--shadow-color-s', '--shadow-color-l', '--shadow-highlight-modifier',
    var.$default-color-bg-primary-h, var.$default-color-bg-primary-s, var.$default-color-bg-primary-l,
    var.$default-shadow-opacity-soft, var.$default-shadow-color-h, var.$default-shadow-color-s, var.$default-shadow-color-l, var.$default-shadow-highlight-l-factor
  );
  // Specific background tint based on role, subtle
  &.avatar-user { background-color: hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.1); }
  &.avatar-assistant { background-color: hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.1); }
  &.avatar-tool { background-color: hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 0.1); }
  &.avatar-system, &.avatar-error { background-color: hsla(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l), 0.1); }
  &.avatar-error { background-color: hsla(var(--color-error-h), var(--color-error-s), var(--color-error-l), 0.1); }

  .avatar-svg-ephemeral {
    width: 20px;
    height: 20px;
    opacity: 1; // Icons should be fully opaque for readability
    // Role-specific icon colors - ensure high contrast with their respective avatar backgrounds
    // These selectors target the SVG if it's a direct child of the role-specific avatar wrapper
    .message-role-user & { color: hsl(var(--color-voice-user-h), var(--color-voice-user-s), calc(var(--color-voice-user-l) - 15%)); }
    .message-role-assistant & { color: hsl(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), calc(var(--color-voice-ai-speaking-l) - 15%)); }
    .message-role-tool & { color: hsl(var(--color-accent-secondary-h), var(--color-accent-secondary-s), calc(var(--color-accent-secondary-l) - 15%)); }
    .message-role-system & { color: hsl(var(--color-text-muted-h), var(--color-text-muted-s), calc(var(--color-text-muted-l) - 15%)); }
    .message-role-error & { color: hsl(var(--color-error-h), var(--color-error-s), calc(var(--color-error-l) - 10%)); }
  }
}

.sender-name-ephemeral {
  font-weight: 600;
  font-size: calc(var.$font-size-base-default); // Clear sender name
  letter-spacing: 0.01em;
  // Specific role colors are applied by parent bubble styles
}

.timestamp-ephemeral {
  font-size: var.$font-size-xs; // Kept small
  color: hsl(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l));
  margin-left: auto;
  padding-left: var.$spacing-sm;
  opacity: 0.75; // Slightly more visible
}

// --- Message Content Area ---
.message-content-area-ephemeral {
  font-size: var.$font-size-base-default;
  line-height: 1.75; // Generous line height for readability
  color: hsl(var(--color-text-primary-h), var(--color-text-primary-s), var(--color-text-primary-l));
  word-wrap: break-word;
  overflow-wrap: break-word;

  // Markdown content styling
  :deep(h1), :deep(h2), :deep(h3), :deep(h4), :deep(h5), :deep(h6) {
    color: hsl(var(--color-text-primary-h), var(--color-text-primary-s), var(--color-text-primary-l)) !important;
    margin-top: var.$spacing-lg !important;
    margin-bottom: var.$spacing-sm !important;
    padding-bottom: var.$spacing-xs !important;
    border-bottom: 1px solid hsla(var(--color-border-primary-h), var(--color-border-primary-s), var(--color-border-primary-l), 0.2) !important;
    font-weight: 600;
    letter-spacing: -0.01em;
    &:first-child { margin-top: 0 !important; }
  }
  :deep(p) {
    margin-bottom: var.$spacing-md !important; // Default paragraph spacing
    color: hsl(var(--color-text-secondary-h), var(--color-text-secondary-s), var(--color-text-secondary-l));
  }
  :deep(ul), :deep(ol) {
    margin-left: 0 !important;
    padding-left: var.$spacing-lg !important; // Standard list indent
    margin-bottom: var.$spacing-md !important;
    li { 
      margin-bottom: var.$spacing-xs !important; 
      color: hsl(var(--color-text-secondary-h), var(--color-text-secondary-s), var(--color-text-secondary-l));
      &::marker {
        color: hsl(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l)) !important;
      }
    }
  }
  :deep(a) { /* ... (styles from previous _message.scss are good) ... */ }
  :deep(blockquote) { /* ... (styles from previous _message.scss are good) ... */ }
  :deep(hr) { /* ... (styles from previous _message.scss are good) ... */ }
  
  :deep(code:not(pre code)) { // Inline code
    background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.7) !important;
    color: hsl(var(--color-text-accent-h), var(--color-text-accent-s), var(--color-text-accent-l)) !important;
    padding: 0.2em 0.45em !important;
    border-radius: var.$radius-sm !important;
    font-size: 0.9em !important;
    border: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.3) !important;
    box-shadow: inset 0 0 3px hsla(var(--color-accent-primary-h), var(--color-accent-primary-s), var(--color-accent-primary-l), 0.05);
  }

  // --- Enhanced Code Block Styling ---
  .code-block-wrapper {
    position: relative;
    margin: var.$spacing-lg 0;
    border-radius: var.$radius-lg; // Consistent with message bubble
    overflow: hidden; // Crucial for child elements like header and pre's rounded corners
    
    @include mixins.neomorphic-inset(
      '--color-bg-primary', // Base color for inset calculation
      8px, 4px, // blur, distance (deeper inset)
      '--shadow-opacity-soft',
      var.$radius-lg,
      '--shadow-color-h', '--shadow-color-s', '--shadow-color-l', '--shadow-highlight-modifier',
      var.$default-color-bg-primary-h, var.$default-color-bg-primary-s, calc(var.$default-color-bg-primary-l - 5%), // Darker inset base
      var.$default-shadow-opacity-soft, var.$default-shadow-color-h, var.$default-shadow-color-s, var.$default-shadow-color-l, var.$default-shadow-highlight-l-factor
    );
    // Actual background for the code, sits on top of the inset effect's base
    // Ensure --color-bg-code-block-h/s/l are defined in your themes (e.g., a dark charcoal for light themes, very dark gray for dark themes)
    background-color: hsl(var(--color-bg-code-block-h, 220), var(--color-bg-code-block-s, 10%), var(--color-bg-code-block-l, 15%)); // Default darkish code bg

    .code-header-ephemeral {
      display: flex;
      justify-content: flex-end; // Align items to the right (lang tag can be added to left or this adjusted)
      align-items: center;
      padding: var.$spacing-xs var.$spacing-sm;
      // Subtle glass effect for code header
      background-color: hsla(var(--color-bg-code-block-h, 220), var(--color-bg-code-block-s, 10%), calc(var(--color-bg-code-block-l, 15%) + 5%), 0.5); // Slightly lighter than code bg, with alpha
      backdrop-filter: blur(3px);
      border-bottom: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.15);
      // Language tag would go here if needed, styled separately. For now, focusing on copy button.
    }

    .code-language-label { // Assuming this class is added in Message.vue if lang is present
      font-size: var.$font-size-xs;
      font-family: var(--font-mono);
      color: hsl(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l));
      padding: 2px var.$spacing-xs;
      background-color: hsla(var(--color-bg-primary-h), var(--color-bg-primary-s), var(--color-bg-primary-l), 0.3);
      border-radius: var.$radius-sm;
      text-transform: uppercase;
      opacity: 0.7;
      margin-right: auto; // Pushes to the left
    }

    .copy-code-button {
      @include buttonsFile.btn-ghost;
      @include buttonsFile.btn-xs-modifier;
      padding: calc(var.$spacing-xs * 0.6) !important;
      color: hsl(var(--color-text-muted-h),var(--color-text-muted-s),var(--color-text-muted-l));
      border-radius: var.$radius-sm;
      background-color: hsla(var(--color-bg-primary-h), var(--color-bg-primary-s), var(--color-bg-primary-l), 0.2);
      &:hover {
        color: hsl(var(--color-accent-interactive-h),var(--color-accent-interactive-s),var(--color-accent-interactive-l));
        background-color: hsla(var(--color-accent-interactive-h),var(--color-accent-interactive-s),var(--color-accent-interactive-l), 0.2) !important;
        border-color: hsla(var(--color-accent-interactive-h),var(--color-accent-interactive-s),var(--color-accent-interactive-l), 0.4);
      }
      svg { width: 18px; height: 18px; }
    }

    pre {
      margin: 0 !important;
      padding: var.$spacing-md;
      padding-left: 0; // Line numbers will create left padding
      background-color: transparent !important; // Wrapper provides background
      border: none !important;
      box-shadow: none !important;
      overflow-x: auto;
      @include mixins.custom-scrollbar(
        '--color-accent-secondary', 0.3, 0.5, 
        '--color-bg-code-block', 0.1, // Use code block bg for track base
        4px // Slimmer scrollbar for code
      );

      code.hljs { // From your global highlight.js theme
        font-family: var(--font-family-mono, var.$font-family-mono);
        font-size: var.$font-size-sm; // Consistent code size
        line-height: 1.65;
        // Ensure your hljs theme (e.g., atom-one-dark-pro.css) is imported and provides good contrast
        // against the var(--color-bg-code-block-h/s/l)
        // Example: Text color for general code if not set by hljs theme
        color: hsl(var(--color-text-code-block-h, 200), var(--color-text-code-block-s, 15%), var(--color-text-code-block-l, 85%)); // Ensure these CSS vars are in theme
      }

      .line-number {
        display: inline-block;
        width: 3em; // Ample space for line numbers
        text-align: right;
        padding-right: var.$spacing-md;
        margin-right: var.$spacing-sm;
        color: hsla(var(--color-text-muted-h), var(--color-text-muted-s), var(--color-text-muted-l), 0.35);
        border-right: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.1);
        user-select: none;
        font-size: var.$font-size-xs * 0.9;
        line-height: inherit; // Match code line height
        position: sticky; left: 0; // Stick line numbers on horizontal scroll
        background-color: hsl(var(--color-bg-code-block-h, 220), var(--color-bg-code-block-s, 10%), var(--color-bg-code-block-l, 15%)); // Match pre background for sticky
        z-index: 1;
      }
      .line-content { /* Content of the line */ }
    }
  }

  .diagram-placeholder-ephemeral { /* ... */ }
  .embedded-diagram-viewer { /* ... */ }
}

// Keyframe for message entry
@keyframes messageAppear {
  from { opacity: 0; transform: translateY(12px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
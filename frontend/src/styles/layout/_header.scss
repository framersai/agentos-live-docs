// File: frontend/src/styles/layout/_header.scss
/**
 * @file _header.scss
 * @description Styles for the main application header, "Ephemeral Harmony" theme.
 * Features glassmorphism, holographic accents, themed controls, dynamic activity indicators,
 * and integrates the new UserSettingsDropdown, SiteMenuDropdown, and VoiceControlsDropdown.
 * @version 3.1.0 - Added SiteMenuDropdown integration.
 */

@use '../abstracts/variables' as var;
@use '../abstracts/mixins' as mixins;
@use '../components/buttons' as buttonsFile;

.app-header-ephemeral {
  height: var(--header-height, 64px); // Use CSS var, fallback to SCSS var
  padding: 0 var.$spacing-md; // Main horizontal padding
  display: flex;
  align-items: center;
  justify-content: center; // Center the content wrapper
  position: sticky;
  top: 0;
  z-index: var.$z-index-sticky;

  @include mixins.glassmorphic-pane(
    '--color-bg-primary', // CSS Var prefix for HSL components
    '--color-border-glass', // CSS Var prefix for HSL components
    '--blur-glass', // CSS Var for blur amount
    '--shadow-depth-sm', // CSS Var for box-shadow string
    // SCSS Fallbacks (only if CSS vars are somehow not defined)
    var.$default-color-bg-primary-h, var.$default-color-bg-primary-s, var.$default-color-bg-primary-l, 0.45, // bg
    var.$default-color-border-glass-h, var.$default-color-border-glass-s, var.$default-color-border-glass-l, 0.2, // border
    var.$blur-glass-default, // blur
    var.$scss-box-shadow-sm // shadow
  );
  border-bottom: 1px solid hsla(var(--color-border-glass-h), var(--color-border-glass-s), var(--color-border-glass-l), 0.2);
  transition: all var.$duration-smooth var.$ease-out-quad;

  &.ai-speaking-active {
    border-bottom-color: hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.7);
    box-shadow: var(--shadow-depth-sm),
      0 0 25px 5px hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.35),
      inset 0 -2px 5px hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.1);
  }
  &.user-listening-active {
    border-bottom-color: hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.7);
    box-shadow: var(--shadow-depth-sm),
      0 0 25px 5px hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.35),
      inset 0 -2px 5px hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.1);
  }
}

.header-content-wrapper-ephemeral {
  width: 100%;
  max-width: var.$site-max-width;
  margin: 0 auto;
  padding: 0 var.$spacing-xs;
  display: grid;
  grid-template-columns: auto 1fr auto; // Logo | Center (Hearing Icon) | Controls
  align-items: center;
  height: 100%;
  gap: var.$spacing-md;

  @media (max-width: var.$breakpoint-md) {
    grid-template-columns: auto 1fr; // Logo | Controls
    .header-center-section { display: none; }
  }
  @media (max-width: var.$breakpoint-sm) {
    gap: var.$spacing-sm;
    padding: 0 var.$spacing-xs; // Ensure some padding on smallest screens
  }
}

.header-left-section {
  display: flex;
  align-items: center;
  justify-self: start;
}

.logo-title-link-ephemeral {
  display: inline-flex;
  align-items: center;
  gap: var.$spacing-sm;
  text-decoration: none;
  color: hsl(var(--color-text-primary-h), var(--color-text-primary-s), var(--color-text-primary-l));
  transition: filter 0.3s var.$ease-out-quad;

  &:hover, &:focus-visible {
    filter: brightness(1.1);
    .app-logo-ephemeral {
      transform: scale(1.12) rotate(12deg);
      filter: drop-shadow(0 0 12px hsla(var(--color-accent-primary-h), var(--color-accent-primary-s), var(--color-accent-primary-l), 0.8));
    }
    .app-title-ephemeral {
      @include mixins.text-glow('--color-accent-primary', 7px, 0.9); // Use SCSS var names for mixin
    }
  }
  &:focus-visible {
    outline: none;
    border-radius: var.$radius-sm;
    @include mixins.focus-ring(
      '--color-bg-primary', // CSS Var prefix
      '--color-accent-primary', // CSS Var prefix
      1px, 2px, 0.9,
      // SCSS Fallbacks
      var.$default-color-bg-primary-h, var.$default-color-bg-primary-s, var.$default-color-bg-primary-l,
      var.$default-color-accent-primary-h, var.$default-color-accent-primary-s, var.$default-color-accent-primary-l
    );
  }
}

.app-logo-ephemeral {
  width: 32px; // Slightly smaller default
  height: 32px;
  transition: transform 0.4s var.$ease-elastic, filter 0.3s var.$ease-out-quad;
  filter: drop-shadow(0 0 8px hsla(var(--color-accent-primary-h), var(--color-accent-primary-s), var(--color-accent-primary-l), 0.6));

  @media (min-width: var.$breakpoint-sm) {
    width: 36px;
    height: 36px;
  }
}

.app-title-ephemeral {
  font-family: var(--font-family-display, var.$font-family-display);
  font-size: clamp(1rem, 0.8rem + 0.6vw, 1.25rem); // Slightly smaller responsive title
  line-height: 1;
  letter-spacing: 0.01em;
  white-space: nowrap;
  @include mixins.text-glow('--color-accent-primary', 6px, 0.7); // Use SCSS var names for mixin
  transition: text-shadow 0.3s var.$ease-out-quad;
  .font-light { opacity: 0.75; font-weight: 300; }

  @media (min-width: var.$breakpoint-sm) {
    font-size: clamp(1.1rem, 0.9rem + 0.6vw, 1.35rem);
  }
}

.header-center-section {
  justify-self: center;
}

.hearing-icon-wrapper-ephemeral {
  width: 38px; // Standardized size
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var.$radius-full;
  transition: all var.$duration-smooth var.$ease-out-quad;
  position: relative;

  &::before { // Base ambient animated glow
    content: '';
    position: absolute;
    inset: -2px; // Tighter glow
    border-radius: inherit;
    background: conic-gradient(
      from 0deg,
      hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 0.05),
      hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 0.02),
      hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 0.05)
    );
    animation: spin 10s linear infinite; // Slower ambient spin
    z-index: -1;
    opacity: 0.6;
    transition: opacity 0.3s, background 0.3s, inset 0.3s;
  }

  .hearing-icon-svg {
    width: 85%;
    height: 85%;
    opacity: 0.5;
    transition: opacity 0.3s, transform 0.3s var.$ease-out-quad;
    // Consider how the SVG's internal animation interacts with these wrapper states
    // The SVG itself has its own complex animations.
    // We might need to control those via JS or further CSS if direct prop changes aren't enough.
  }

  &.idle {
    .hearing-icon-svg { opacity: 0.35; transform: scale(0.9); }
    &::before { opacity: 0.4; animation-duration: 15s; inset: -1px; }
  }

  &.listening { // User is speaking - Bright pulsating user color
    background-color: hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.08);
    &::before {
      background: conic-gradient(
        from 0deg,
        hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.25),
        hsla(var(--color-voice-user-h), var(--color-voice-user-s), calc(var(--color-voice-user-l) + 10%), 0.1),
        hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.25)
      );
      animation-duration: 3s; animation-name: spin, subtlePulse; --scale-pulse: 1.1; --opacity-pulse: 1;
      opacity: 0.9;
      inset: -3px;
    }
    .hearing-icon-svg { opacity: 0.9; transform: scale(1); }
  }

  &.speaking { // AI is speaking - Bright pulsating AI color
    background-color: hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.08);
    &::before {
      background: conic-gradient(
        from 0deg,
        hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.3),
        hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), calc(var(--color-voice-ai-speaking-l) + 10%), 0.15),
        hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.3)
      );
      animation-duration: 2.5s; animation-name: spin, subtlePulse; --scale-pulse: 1.12; --opacity-pulse: 1;
      opacity: 1;
      inset: -4px;
    }
    .hearing-icon-svg { opacity: 1; transform: scale(1.05); }
  }
}

.header-right-section {
  display: flex;
  align-items: center;
  gap: var.$spacing-xs; // Tighter gap by default
  justify-self: end;

  @media (min-width: var.$breakpoint-sm) {
    gap: var.$spacing-sm;
  }
}

.session-cost-display-ephemeral {
  padding: calc(var.$spacing-xs + 1px) var.$spacing-sm;
  border-radius: var.$radius-md;
  font-family: var(--font-mono, var.$font-family-mono);
  font-size: var.$font-size-xs;
  color: hsl(var(--color-text-secondary-h), var(--color-text-secondary-s), var(--color-text-secondary-l));
  background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.5);
  border: 1px solid hsla(var(--color-border-secondary-h), var(--color-border-secondary-s), var(--color-border-secondary-l), 0.4);
  min-width: 70px;
  text-align: right;
  white-space: nowrap;
  transition: all var.$duration-quick;
  @include mixins.text-glow('--color-accent-secondary', 3px, 0.2); // Use SCSS var names for mixin

  .cost-value {
    font-weight: 600;
    color: hsl(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l));
  }
  &:hover {
    background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.7);
    border-color: hsla(var(--color-accent-secondary-h), var(--color-accent-secondary-s), var(--color-accent-secondary-l), 0.5);
  }
}

// Ensure dropdown trigger buttons are consistently styled
// These styles will apply to the trigger buttons of UserSettingsDropdown, SiteMenuDropdown, VoiceControlsDropdown
// if they use the common .btn-ghost-ephemeral.btn-icon-ephemeral classes.
.btn.btn-ghost-ephemeral.btn-icon-ephemeral {
  color: hsl(var(--color-text-secondary-h), var(--color-text-secondary-s), var(--color-text-secondary-l));
  &:hover, &:focus-visible {
    color: hsl(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l));
    background-color: hsla(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l), 0.08);
  }
}

// Ensure dropdowns have consistent styling (assuming they use card-neo-raised or similar)
// And that dropdown items use .dropdown-item-holographic for consistent look & feel.
// Specifics for .dropdown-item-holographic might be in a global _dropdowns.scss or _cards.scss
// File: frontend/src/styles/layout/_header.scss
/**
 * @file _header.scss
 * @version 8.3.1
 * @description Fully refined and complete styles for Header.vue and the new MobileNavPanel.vue.
 * Ensures mobile navigation panel is full height, visible, scrollable, and smoothly animated.
 * Desktop header styles are consistent with "Ephemeral Harmony".
 * Corrects issues with mobile panel visibility, height, background, and transitions.
 *
 * @role Defines the visual appearance and layout of the global application header and mobile navigation panel.
 * @dependencies `../abstracts/variables`, `../abstracts/mixins`, `../components/buttons`, `../components/dropdowns`.
 * @assumptions Header.vue and MobileNavPanel.vue component structures match selectors. CSS custom properties for themes are set.
 * Keyframe animations are defined in `_keyframes.scss`.
 */

@use '../abstracts/variables' as var;
@use '../abstracts/mixins' as mixins;
@use '../components/buttons' as buttonsFile;
@use '../components/dropdowns' as dropdownMixins;

// --- Base App Header Styling ---
.app-header-ephemeral {
  // CSS Custom Properties for dynamic header sizing and styling
  --header-height-mobile: 60px;
  --header-height-desktop: 70px;
  --header-actual-height: var(--header-height-mobile); // Default state, overridden by media query
  --header-padding-x-mobile: #{var.$spacing-sm};
  --header-padding-x-desktop: #{var.$spacing-lg};
  --header-padding-x: var(--header-padding-x-mobile); // Default state, overridden by media query
  --header-bg-alpha: 0.85; // Slightly more opacity for header bar for better contrast
  --header-blur: 12px;     // Standard blur for the glass effect

  height: var(--header-actual-height);
  padding: 0 var(--header-padding-x);

  display: flex;
  align-items: center;
  justify-content: center;
  position: sticky; // Stick to the top
  top: 0; left: 0; right: 0;
  z-index: calc(var.$z-index-sticky + 20); // High z-index to be above most page content

  @include mixins.glassmorphic-pane(
    $bg-color-css-var-prefix: '--color-bg-primary',
    $border-color-css-var-prefix: '--color-border-secondary',
    $blur-amount-css-var: '--header-blur',
    $shadow-css-var: '--shadow-depth-lg', // More pronounced shadow for the header
    // SCSS Fallbacks
    $fb-bg-h: var.$default-color-bg-primary-h, $fb-bg-s: var.$default-color-bg-primary-s, $fb-bg-l: var.$default-color-bg-primary-l, $fb-bg-a: var(--header-bg-alpha),
    $fb-border-h: var.$default-color-border-secondary-h, $fb-border-s: var.$default-color-border-secondary-s, $fb-border-l: var.$default-color-border-secondary-l, $fb-border-a: 0.3, // Slightly more visible border
    $fb-blur: 12px,
    $fb-shadow: var.$scss-box-shadow-lg
  );
  border-width: 0; // Remove side/top borders from the mixin
  border-bottom-width: 1px; // Keep only the bottom border for visual separation

  transition: background-color var.$duration-smooth var.$ease-out-quad,
              border-bottom-color var.$duration-smooth var.$ease-out-quad,
              box-shadow var.$duration-smooth var.$ease-out-quad;

  // Dynamic "under-glow" effect based on application state
  &::before {
    content: '';
    position: absolute;
    left: 0; right: 0; bottom: -3px;
    height: 60px;
    border-radius: 45%;
    background: transparent;
    opacity: 0;
    transition: opacity 0.45s var.$ease-out-quad, background 0.45s var.$ease-out-quad, transform 0.45s var.$ease-out-quad;
    z-index: -1;
    pointer-events: none;
    filter: blur(30px);
    transform: scaleX(1.9) translateY(70%);
  }

  // State-specific header styling for glows
  &.user-listening-active {
    border-bottom-color: hsla(var(--color-voice-user-h, var.$default-color-voice-user-h), var(--color-voice-user-s, var.$default-color-voice-user-s), var(--color-voice-user-l, var.$default-color-voice-user-l), 0.8); // More visible border color
    box-shadow: var(--shadow-depth-lg, var.$scss-box-shadow-lg), 0 4px 22px hsla(var(--color-voice-user-h, var.$default-color-voice-user-h), var(--color-voice-user-s, var.$default-color-voice-user-s), var(--color-voice-user-l, var.$default-color-voice-user-l), 0.28); // Enhanced shadow
    &::before {
      opacity: 0.75;
      background: radial-gradient(ellipse at center bottom, hsla(var(--color-voice-user-h, var.$default-color-voice-user-h), var(--color-voice-user-s, var.$default-color-voice-user-s), var(--color-voice-user-l, var.$default-color-voice-user-l), 0.5) 0%, transparent 70%);
      animation: header-state-pulse 2.8s var.$ease-in-out-sine infinite alternate;
    }
  }

  &.ai-speaking-active {
    border-bottom-color: hsla(var(--color-voice-ai-speaking-h, var.$default-color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s, var.$default-color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l, var.$default-color-voice-ai-speaking-l), 0.9); // Strongest border color
    box-shadow: var(--shadow-depth-xl, var.$scss-box-shadow-xl), 0 5px 28px hsla(var(--color-voice-ai-speaking-h, var.$default-color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s, var.$default-color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l, var.$default-color-voice-ai-speaking-l), 0.32); // Strongest shadow
    &::before {
      opacity: 0.85;
      background: radial-gradient(ellipse at center bottom, hsla(var(--color-voice-ai-speaking-h, var.$default-color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s, var.$default-color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l, var.$default-color-voice-ai-speaking-l), 0.65) 0%, transparent 70%);
      animation: header-state-pulse 2.0s var.$ease-in-out-quad infinite alternate;
    }
  }

  // Responsive adjustments for header height and padding
  @media (min-width: var.$breakpoint-md) {
    --header-actual-height: var(--header-height-desktop);
    --header-padding-x: var(--header-padding-x-desktop);
  }
}

.header-content-wrapper-ephemeral {
  width: 100%;
  max-width: var.$site-max-width;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 100%;
  gap: var.$spacing-sm;
}

// --- Left Section: Logo and Optional Current Agent Display ---
.header-left-section {
  display: flex;
  align-items: center;
  flex-shrink: 0; // Important to prevent shrinking
  gap: var.$spacing-sm;
  @media (min-width: var.$breakpoint-md) { gap: var.$spacing-md; }

  .animated-logo-link { // Wrapper for AnimatedLogo component
    display: inline-flex;
    align-items: center; // Vertically align if AnimatedLogo has intrinsic height
    padding: var.$spacing-xs;
    margin: calc(var.$spacing-xs * -1); // Visual alignment for better spacing perception
    border-radius: var.$radius-md;
    transition: background-color var.$duration-quick;
    &:hover, &:focus-visible {
      background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.35); // Slightly more noticeable hover
    }
    &:focus-visible { @include mixins.focus-ring('--color-bg-primary', '--color-accent-interactive', 0px, 2px, 0.95); }
  }
}
.current-agent-display-header {
  display: none; // Mobile-first: hidden
  @media (min-width: var.$breakpoint-lg) { // Show on large screens
    display: flex;
    align-items: center;
    gap: var.$spacing-sm;
    padding: calc(var.$spacing-xs + 3px) calc(var.$spacing-sm + 2px); // Slightly more padding
    border-radius: var.$radius-lg;
    background-color: hsla(var(--color-bg-secondary-h), var(--color-bg-secondary-s), var(--color-bg-secondary-l), 0.6);
    border: 1px solid hsla(var(--color-border-primary-h), var(--color-border-primary-s), var(--color-border-primary-l), 0.45);
    max-width: 240px;
    transition: background-color var.$duration-quick, box-shadow var.$duration-smooth var.$ease-out-quad;
    cursor: default;

    &:hover {
      background-color: hsla(var(--color-bg-secondary-h), var(--color-bg-secondary-s), var(--color-bg-secondary-l), 0.8);
      box-shadow: var(--shadow-depth-md, var.$scss-box-shadow-md);
    }

    .agent-icon-header {
      width: 24px; height: 24px;
      color: hsl(var(--color-accent-secondary-h, var.$default-color-accent-secondary-h), var(--color-accent-secondary-s, var.$default-color-accent-secondary-s), var(--color-accent-secondary-l, var.$default-color-accent-secondary-l));
    }
    .agent-name-header {
      font-size: var.$font-size-sm;
      font-weight: 500;
      color: hsl(var(--color-text-secondary-h), var(--color-text-secondary-s), calc(var(--color-text-secondary-l) + 5%)); // Brighter text
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
  }
  @media (min-width: var.$breakpoint-xl) { max-width: 300px; } // Allow more width on XL screens
}

// --- Center Section: Hearing Indicator ---
.header-center-section {
  flex-grow: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  min-width: 40px;
  // Hidden on small screens to give more space to left/right sections
  @media (max-width: calc(var.$breakpoint-md - 1px)) { display: none; }
}

.hearing-icon-wrapper-ephemeral {
  position: absolute;
  left: 50%; top: 50%;
  transform: translate(-50%, -50%) scale(1);
  pointer-events: none;
  padding: var.$spacing-xs;
  border-radius: var.$radius-full;
  transition: transform 0.5s var.$ease-elastic, filter 0.4s var.$ease-out-quad;

  .hearing-icon-svg { // The actual <img src="@/assets/hearing.svg">
    width: 32px; height: 32px;
    @media (min-width: var.$breakpoint-md) { width: 36px; height: 36px; }
    @media (min-width: var.$breakpoint-lg) { width: 38px; height: 38px; } // Slightly larger
    opacity: 0.75; // Default idle opacity more visible
    transition: opacity 0.4s, filter 0.4s var.$ease-out-quad, transform 0.4s var.$ease-elastic;
    filter: drop-shadow(0 0 5px hsla(var(--color-bg-primary-h), var(--color-bg-primary-s), var(--color-bg-primary-l), 0.35));
  }
}
// State-based transforms and effects for the hearing icon wrapper
.app-header-ephemeral.user-listening-active .hearing-icon-wrapper-ephemeral {
  transform: translate(-50%, -50%) scale(1.25);
  .hearing-icon-svg {
    opacity: 1;
    filter: drop-shadow(0 0 20px hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.95))
            drop-shadow(0 0 7px hsla(var(--color-voice-user-h), var(--color-voice-user-s), var(--color-voice-user-l), 0.75));
    // Add a subtle throb to the SVG wrapper itself for this state
    animation: hearing-icon-throb-user 1.8s var.$ease-in-out-sine infinite alternate;
  }
}
.app-header-ephemeral.ai-speaking-active .hearing-icon-wrapper-ephemeral {
  transform: translate(-50%, -50%) scale(1.3);
  .hearing-icon-svg {
    opacity: 1;
    filter: drop-shadow(0 0 25px hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 1))
            drop-shadow(0 0 9px hsla(var(--color-voice-ai-speaking-h), var(--color-voice-ai-speaking-s), var(--color-voice-ai-speaking-l), 0.85));
    animation: hearing-icon-throb-ai 1.3s var.$ease-in-out-quad infinite alternate;
  }
}

@keyframes hearing-icon-throb-user {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.08); }
}
@keyframes hearing-icon-throb-ai {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.12); }
}

// --- Right Section: Desktop Controls ---
.header-right-section.desktop-controls-ephemeral {
  display: none;
  @media (min-width: var.$breakpoint-lg) { // Show only on large screens
    display: flex;
    align-items: center;
    flex-shrink: 0;
    gap: calc(var.$spacing-xs + 3px); // Consistent gap
  }
  > .header-control-item { // Wrapper for dropdowns to ensure relative positioning context
    position: relative;
    display: flex;
    align-items: center;
  }
}

// Unified styling for all header icon buttons and dropdown triggers
.direct-header-button,
:deep(.agent-hub-trigger-button.direct-header-button),
.user-settings-dropdown-header > button,
.voice-controls-dropdown-header > button,
.site-menu-dropdown-header > .nexus-orb-trigger, // Specific target for SiteMenu button
.theme-dropdown-header > button,
.mobile-menu-trigger-button { // Applies to mobile hamburger as well
  @include buttonsFile.btn;
  @include buttonsFile.btn-ghost-look;
  @include buttonsFile.btn-icon-modifier;

  padding: calc(var.$spacing-sm * 0.8) !important; // Standardized padding for a good click area
  border-radius: var.$radius-xl !important;
  color: hsl(var(--color-text-secondary-h), var(--color-text-secondary-s), calc(var(--color-text-secondary-l) + 15%)); // Brighter text
  min-width: calc(var(--header-actual-height) * 0.58); // Ensure minimum size
  min-height: calc(var(--header-actual-height) * 0.58);
  display: inline-flex; align-items: center; justify-content: center; // Ensure icon is centered

  // Default icon size (SiteMenuDropdown styles its own SVG size)
  .icon-base, .icon-sm, .icon-xs {
    width: 1.45rem; height: 1.45rem;
    opacity: 0.92;
    transition: opacity 0.2s, transform 0.3s var.$ease-elastic;
    @media (min-width: var.$breakpoint-xl) { width: 1.65rem; height: 1.65rem; }
  }

  &:hover, &:focus-visible, &[aria-expanded="true"] {
    background-color: hsla(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l), 0.3) !important; // More noticeable hover
    color: hsl(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l)) !important;
    > .icon-base, > .icon-sm, > .icon-xs, > .nexus-orb-svg {
      opacity: 1;
      transform: scale(1.25) rotate(-10deg); // More dynamic hover effect
    }
  }
  &:active {
    transform: scale(0.88) !important; // Pronounced press effect
    background-color: hsla(var(--color-accent-interactive-h), var(--color-accent-interactive-s), var(--color-accent-interactive-l), 0.35) !important;
  }
  &:focus-visible {
    @include mixins.focus-ring('--color-bg-primary', '--color-accent-interactive', 0px, 3px, 0.95); // Clearer focus ring
  }
}

.theme-dropdown-header, .voice-controls-dropdown-header, .user-settings-dropdown-header, .site-menu-dropdown-header {
  position: relative; // Ensures dropdown panels are positioned correctly relative to these triggers
}

.session-cost-display-ephemeral {
  // Styles are generally fine, ensure text color has good contrast
  color: hsl(var(--color-text-primary-h), var(--color-text-primary-s), var(--color-text-primary-l));
  background-color: hsla(var(--color-bg-tertiary-h), var(--color-bg-tertiary-s), var(--color-bg-tertiary-l), 0.4);
  border: 1px solid hsla(var(--color-border-secondary-h),var(--color-border-secondary-s),var(--color-border-secondary-l), 0.3);
}

// --- Mobile Menu Trigger & Panel ---
.mobile-menu-trigger-wrapper-ephemeral {
  display: flex;
  align-items: center;
  gap: var.$spacing-xs;
  @media (min-width: var.$breakpoint-lg) { display: none; } // Hide on large screens

  .mobile-menu-trigger-button .icon-base { width: 1.85rem; height: 1.85rem; } // Larger tap target for hamburger
  :deep(.mobile-agent-hub-trigger .direct-header-button .icon-base) { width: 1.7rem; height: 1.7rem; }
}

.mobile-nav-panel-ephemeral { // Styles for the root of MobileNavPanel.vue
  position: fixed;
  inset: 0;
  height: 100vh; // Fallback
  height: 100dvh; // Ensure full dynamic viewport height
  z-index: var.$z-index-modal;
  display: flex;
  flex-direction: column;
  overflow: hidden; // Panel itself does not scroll

  @include mixins.glassmorphic-pane(
    $bg-color-css-var-prefix: '--color-bg-primary',
    $border-color-css-var-prefix: '--color-border-primary',
    $blur-amount-css-var: #{calc(12px + 10px)}, // Significant blur for overlay panel
    $shadow-css-var: '--shadow-depth-xl', // Add shadow to make it feel on top
    $fb-bg-h: var.$default-color-bg-primary-h, $fb-bg-s: var.$default-color-bg-primary-s, $fb-bg-l: var.$default-color-bg-primary-l, $fb-bg-a: 0.97, // Near opaque
    $fb-border-h: var.$default-color-border-primary-h, $fb-border-s: var.$default-color-border-primary-s, $fb-border-l: var.$default-color-border-primary-l, $fb-border-a: 0.3,
    $fb-blur: 22px,
    $fb-shadow: var.$scss-box-shadow-xl
  );
  // Solid fallback background if glassmorphism isn't fully supported or for contrast
  background-color: hsl(var(--color-bg-primary-h), var(--color-bg-primary-s), var(--color-bg-primary-l));

  .mobile-nav-header-ephemeral { // Header within the mobile panel
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 var(--header-padding-x-mobile);
    height: var(--header-actual-height); // Use the main header's height for consistency
    border-bottom: 1px solid hsla(var(--color-border-primary-h),var(--color-border-primary-s),var(--color-border-primary-l), 0.35); // Clearer divider
    flex-shrink: 0; // Header should not shrink

    .animated-logo-link { /* Inherits from main header */ }
    .mobile-nav-agent-title-compact { /* Inherits from main header */ }
    .mobile-nav-close-button { // Uses .direct-header-button styles
       color: hsl(var(--color-text-primary-h), var(--color-text-primary-s), var(--color-text-primary-l));
        &:hover {
             background-color: hsla(var(--color-error-h), var(--color-error-s), var(--color-error-l), 0.2) !important;
             color: hsl(var(--color-error-h), var(--color-error-s), var(--color-error-l)) !important;
        }
    }
  }

  .mobile-nav-content-ephemeral {
    padding: var.$spacing-lg var.$spacing-md; // Generous padding
    @media (min-width: var.$breakpoint-sm) { padding: var.$spacing-xl var.$spacing-lg; }
    flex-grow: 1;               // CRITICAL: Fills available vertical space
    overflow-y: auto;           // CRITICAL: Enables scrolling for this content area
    // No explicit height needed because flex-grow handles it

    @include mixins.custom-scrollbar(
      '--color-accent-interactive', 0.75, 0.98, // Very visible scrollbar
      '--color-bg-secondary', 0.3, 8px, var.$radius-md
    );
  }

  // Styles for items within the mobile navigation (ensure class names match MobileNavPanel.vue)
  .mobile-nav-item-ephemeral {
    // ... (styles from previous iteration are generally good, focus on padding, font-size, interaction)
    padding: calc(var.$spacing-md - 2px) var.$spacing-md; // Comfortable tap targets
    font-size: var.$font-size-lg; // Clear, readable font size
    // ... rest of hover, focus, active states ...
     &.prominent-action { /* fine */ }
     &.logout-item { /* fine */ }
     &.theme-button-mobile { /* fine */ }
  }

  .mobile-nav-divider-ephemeral { /* fine */ }
  .mobile-nav-section-title-ephemeral { /* fine */ }
  .theme-selector-grid-mobile { /* fine */ }
  .mobile-nav-item-static { /* fine */ }
}

// Mobile Nav Panel Transition (ensure name matches MobileNavPanel.vue's <Transition> name)
.mobile-nav-slide-from-right-ephemeral-enter-active,
.mobile-nav-slide-from-right-ephemeral-leave-active {
  transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), // Smoother easing
              opacity 0.35s ease-out;
}
.mobile-nav-slide-from-right-ephemeral-enter-from,
.mobile-nav-slide-from-right-ephemeral-leave-to {
  transform: translateX(100%);
  opacity: 0; // Start fully transparent
}

// Keyframe for header background pulse effect for active states
@keyframes header-state-pulse {
  0%, 100% { opacity: 0.6; transform: scaleX(1.9) translateY(68%); }
  50% { opacity: 0.95; transform: scaleX(2.15) translateY(60%); } // More intense pulse
}
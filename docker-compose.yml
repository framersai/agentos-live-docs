# File: docker-compose.yml
version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: vca-postgres
    environment:
      POSTGRES_DB: voice_chat_assistant
      POSTGRES_USER: vca_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-vca_secure_password_change_in_production}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/prisma/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - voice_chat_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vca_user -d voice_chat_assistant"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: vca-redis
    command: redis-server --appendonly yes --requirepass "${REDIS_PASSWORD:-redis_secure_password}"
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - voice_chat_network
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-redis_secure_password}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Voice Chat Assistant Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-development}
    container_name: vca-backend
    ports:
      - "${BACKEND_PORT:-3001}:3001"
    environment:
      # Core Application
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3001
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - APP_URL=${APP_URL:-http://localhost:3001}
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      
      # Database & Cache
      - DATABASE_URL=postgresql://vca_user:${POSTGRES_PASSWORD:-vca_secure_password_change_in_production}@postgres:5432/voice_chat_assistant
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_secure_password}@redis:6379
      
      # Authentication & Security
      - JWT_SECRET=${JWT_SECRET:-voice_chat_assistant_super_secure_jwt_secret_change_in_production_min_64_chars}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - API_KEY_ENCRYPTION_KEY_HEX=${API_KEY_ENCRYPTION_KEY_HEX:-a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456}
      
      # OAuth Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL:-http://localhost:3001/api/v1/auth/google/callback}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      - GITHUB_CALLBACK_URL=${GITHUB_CALLBACK_URL:-http://localhost:3001/api/v1/auth/github/callback}
      
      # LLM Provider API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      
      # Pinecone Configuration
      - PINECONE_API_KEY=${PINECONE_API_KEY:-}
      - PINECONE_ENVIRONMENT=${PINECONE_ENVIRONMENT:-us-east-1}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME:-vca}
      - PINECONE_NAMESPACE=${PINECONE_NAMESPACE:-voice-chat-assistant}
      
      # Model Preferences
      - MODEL_PREF_GENERAL_CHAT=${MODEL_PREF_GENERAL_CHAT:-openai/gpt-4o-mini}
      - MODEL_PREF_CODING=${MODEL_PREF_CODING:-openai/gpt-4o}
      - MODEL_PREF_DEFAULT_EMBEDDING=${MODEL_PREF_DEFAULT_EMBEDDING:-openai/text-embedding-3-small}
      
      # Voice Chat Assistant Configuration
      - DEFAULT_PERSONA_ID=${DEFAULT_PERSONA_ID:-voice_assistant_persona}
      - MAX_ACTIVE_CONVERSATIONS_IN_MEMORY=${MAX_ACTIVE_CONVERSATIONS_IN_MEMORY:-1000}
      - ENABLE_CONVERSATION_SUMMARIZATION=${ENABLE_CONVERSATION_SUMMARIZATION:-true}
      - COST_THRESHOLD=${COST_THRESHOLD:-20.00}
      
      # LemonSqueezy Payment Integration
      - LEMONSQUEEZY_API_KEY=${LEMONSQUEEZY_API_KEY:-}
      - LEMONSQUEEZY_STORE_ID=${LEMONSQUEEZY_STORE_ID:-}
      - LEMONSQUEEZY_WEBHOOK_SECRET=${LEMONSQUEEZY_WEBHOOK_SECRET:-}
      
      # Email Configuration (for production)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@voicechatassistant.com}
      
      # Feature Flags
      - REGISTRATION_ENABLED=${REGISTRATION_ENABLED:-true}
      - EMAIL_VERIFICATION_REQUIRED=${EMAIL_VERIFICATION_REQUIRED:-false}
      - OAUTH_ENABLED=${OAUTH_ENABLED:-true}
      
    volumes:
      - ./backend:/app
      - /app/node_modules
      - vca_storage:/app/storage
      - vca_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - voice_chat_network
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        npm run db:generate &&
        npm run db:push &&
        npm run db:seed &&
        echo 'Database setup complete. Starting server...' &&
        npm run dev
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # Voice Chat Assistant Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-development}
    container_name: vca-frontend
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:3001/api/v1}
      - VITE_WS_URL=${VITE_WS_URL:-ws://localhost:3001}
      - VITE_APP_TITLE=${VITE_APP_TITLE:-Voice Chat Assistant}
      - VITE_APP_DESCRIPTION=${VITE_APP_DESCRIPTION:-An Intelligent, Voice-First Conversational AI Platform}
      - VITE_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - VITE_OAUTH_ENABLED=${OAUTH_ENABLED:-true}
      - VITE_REGISTRATION_ENABLED=${REGISTRATION_ENABLED:-true}
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - voice_chat_network
    command: npm run dev -- --host 0.0.0.0
    restart: unless-stopped

  # Optional: Ollama for local LLM (enable with --profile local-llm)
  ollama:
    image: ollama/ollama:latest
    container_name: vca-ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - voice_chat_network
    profiles:
      - "local-llm"
    restart: unless-stopped
    command: >
      sh -c "
        ollama serve &
        sleep 10 &&
        ollama pull llama3.2:3b &&
        ollama pull codellama:7b &&
        wait
      "

  # Optional: Nginx Reverse Proxy for Production
  nginx:
    image: nginx:alpine
    container_name: vca-nginx
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - frontend
      - backend
    networks:
      - voice_chat_network
    profiles:
      - "production"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Adminer for Database Management
  adminer:
    image: adminer:latest
    container_name: vca-adminer
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
    depends_on:
      - postgres
    networks:
      - voice_chat_network
    profiles:
      - "development"
      - "admin-tools"
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  ollama_data:
    driver: local
  vca_storage:
    driver: local
  vca_logs:
    driver: local
  nginx_logs:
    driver: local

networks:
  voice_chat_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Environment-specific configurations
# Development: docker-compose up -d
# Production: docker-compose --profile production up -d
# With Local LLM: docker-compose --profile local-llm up -d
# With Admin Tools: docker-compose --profile development --profile admin-tools up -d